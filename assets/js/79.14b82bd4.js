(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{426:function(t,a,s){"use strict";s.r(a);var e=s(42),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"csrf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf"}},[t._v("#")]),t._v(" CSRF")]),t._v(" "),s("p",[t._v("Cross site request forgery （跨站请求伪造）。")]),t._v(" "),s("p",[t._v("例如，登录微博账号后，copy 某个 xhr 请求的 "),s("code",[t._v("curl")]),t._v("，丢到控制台或是复制所有 cookie 之类的数据丢到 "),s("code",[t._v("Postman")]),t._v(" 中，这就是跨站请求伪造("),s("code",[t._v("CSRF")]),t._v(")。")]),t._v(" "),s("p",[t._v("第三方引导发出的 "),s("code",[t._v("cookie")]),t._v("，称为第三方 "),s("code",[t._v("cookie")]),t._v("，可用于 "),s("code",[t._v("CSRF")]),t._v(" 攻击，还可以用于用户追踪等营销行为")]),t._v(" "),s("h2",{attrs:{id:"例子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[t._v("#")]),t._v(" 例子")]),t._v(" "),s("ol",[s("li",[t._v("facebook 在第三方网站插入一张看不见的图片")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("facebook.com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token style-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token style language-css"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("visibility")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("hidden")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n")])])]),s("p",[t._v("这时候访问这个图片，就会带上 cookie，facebook 知道你的 "),s("code",[t._v("ip")]),t._v(" 等等数据")]),t._v(" "),s("h2",{attrs:{id:"原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[t._v("#")]),t._v(" 原理")]),t._v(" "),s("p",[t._v("大多数情况下，被第三方网站或者 JS 脚本获取到 "),s("code",[t._v("cookie")]),t._v("，所以防御的手段之一就是防止 "),s("code",[t._v("cookie")]),t._v(" 被获取。")]),t._v(" "),s("h2",{attrs:{id:"防御"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防御"}},[t._v("#")]),t._v(" 防御")]),t._v(" "),s("h3",{attrs:{id:"敏感信息都是用-post"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#敏感信息都是用-post"}},[t._v("#")]),t._v(" 敏感信息都是用 "),s("code",[t._v("POST")])]),t._v(" "),s("ul",[s("li",[t._v("就算是 copy 参数也很多，步骤 比 get 还多")]),t._v(" "),s("li",[t._v("如果网站存在 "),s("code",[t._v("xss")]),t._v(" 漏洞，都很费劲")])]),t._v(" "),s("p",[t._v("比如构造一个 "),s("code",[t._v("from")]),t._v(" 表单")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("foo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("action")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/api/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("method")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("POST"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("text"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forms")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"foo"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("submit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("在 console 执行 script 部分代码，如果有 from， 会直接跳到百度（或许与 Chrome ）设置默认引擎有关系。")]),t._v(" "),s("p",[t._v("尝试在 firefox 中打开阮老师 blog，会网页提示： "),s("code",[t._v("留言提交失败。原因：Invalid request")])]),t._v(" "),s("h3",{attrs:{id:"将-cookie-设置为-httponly"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将-cookie-设置为-httponly"}},[t._v("#")]),t._v(" 将 Cookie 设置为 "),s("code",[t._v("HttpOnly")])]),t._v(" "),s("p",[t._v("对应 header 是： "),s("code",[t._v("Set-Cookie: hello=world;httponly")])]),t._v(" "),s("ul",[s("li",[t._v("JS 脚本将无法读取 "),s("code",[t._v("cookie")]),t._v(" 信息")])]),t._v(" "),s("h3",{attrs:{id:"将-cookie-设置为-samehttp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将-cookie-设置为-samehttp"}},[t._v("#")]),t._v(" 将 Cookie 设置为 "),s("code",[t._v("SameHttp")])]),t._v(" "),s("h3",{attrs:{id:"增加-token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#增加-token"}},[t._v("#")]),t._v(" 增加 token")]),t._v(" "),s("p",[t._v("原理：增加攻击者所不能伪造的信息，且不中存在于 "),s("code",[t._v("cookie")]),t._v(" 中，重点是 "),s("code",[t._v("token")]),t._v(" 的保密性、随机性。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("比如放在 "),s("code",[t._v("Token-Csrf: abcdef")])])]),t._v(" "),s("li",[s("p",[t._v("token 服务端生成，有一定的有效期")])])]),t._v(" "),s("p",[t._v("::: info\n但这种方式，实际上，也躲不过直接复制信息到 "),s("code",[t._v("postman")]),t._v("\n:::")]),t._v(" "),s("h3",{attrs:{id:"根据-referer-判断"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据-referer-判断"}},[t._v("#")]),t._v(" 根据 "),s("code",[t._v("referer")]),t._v(" 判断")]),t._v(" "),s("ul",[s("li",[t._v("用于验证发起请求是否是合法的网站")])])])}),[],!1,null,null,null);a.default=n.exports}}]);