<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Actix-web | 进阶web高级前端知识体系</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="面对web技术全栈，来自@veaba 个人学习笔记以及公开博客文章整理">
    
    <link rel="preload" href="/assets/css/0.styles.cbd9db94.css" as="style"><link rel="preload" href="/assets/js/app.da650921.js" as="script"><link rel="preload" href="/assets/js/2.cfea43a3.js" as="script"><link rel="preload" href="/assets/js/75.9b07dfb3.js" as="script"><link rel="prefetch" href="/assets/js/10.5da23f4b.js"><link rel="prefetch" href="/assets/js/11.d3d1c83e.js"><link rel="prefetch" href="/assets/js/12.772613d1.js"><link rel="prefetch" href="/assets/js/13.ec49721a.js"><link rel="prefetch" href="/assets/js/14.fc6e206d.js"><link rel="prefetch" href="/assets/js/15.009cf3b0.js"><link rel="prefetch" href="/assets/js/16.dadbfe99.js"><link rel="prefetch" href="/assets/js/17.79c44708.js"><link rel="prefetch" href="/assets/js/18.2375a03f.js"><link rel="prefetch" href="/assets/js/19.fe5ed694.js"><link rel="prefetch" href="/assets/js/20.917a5ffd.js"><link rel="prefetch" href="/assets/js/21.8c6475b6.js"><link rel="prefetch" href="/assets/js/22.bde4e132.js"><link rel="prefetch" href="/assets/js/23.f8f70e9d.js"><link rel="prefetch" href="/assets/js/24.293d44a6.js"><link rel="prefetch" href="/assets/js/25.7cae75c1.js"><link rel="prefetch" href="/assets/js/26.5a683528.js"><link rel="prefetch" href="/assets/js/27.49a4c6c1.js"><link rel="prefetch" href="/assets/js/28.2133b4b3.js"><link rel="prefetch" href="/assets/js/29.6ad131c0.js"><link rel="prefetch" href="/assets/js/3.ca39d2c1.js"><link rel="prefetch" href="/assets/js/30.c4ca3815.js"><link rel="prefetch" href="/assets/js/31.73efc52f.js"><link rel="prefetch" href="/assets/js/32.b4e6b601.js"><link rel="prefetch" href="/assets/js/33.8c360491.js"><link rel="prefetch" href="/assets/js/34.0c827d92.js"><link rel="prefetch" href="/assets/js/35.49038485.js"><link rel="prefetch" href="/assets/js/36.0f8b4f9f.js"><link rel="prefetch" href="/assets/js/37.9a886783.js"><link rel="prefetch" href="/assets/js/38.e2af7986.js"><link rel="prefetch" href="/assets/js/39.c6d05eb2.js"><link rel="prefetch" href="/assets/js/4.2363fb5a.js"><link rel="prefetch" href="/assets/js/40.a8d0f478.js"><link rel="prefetch" href="/assets/js/41.140516a4.js"><link rel="prefetch" href="/assets/js/42.68724ce8.js"><link rel="prefetch" href="/assets/js/43.e122cb8e.js"><link rel="prefetch" href="/assets/js/44.b9df3e9d.js"><link rel="prefetch" href="/assets/js/45.aa7e9f09.js"><link rel="prefetch" href="/assets/js/46.0ff412aa.js"><link rel="prefetch" href="/assets/js/47.d010025d.js"><link rel="prefetch" href="/assets/js/48.4aab68ce.js"><link rel="prefetch" href="/assets/js/49.9112a8d5.js"><link rel="prefetch" href="/assets/js/5.1a17c7fd.js"><link rel="prefetch" href="/assets/js/50.66213575.js"><link rel="prefetch" href="/assets/js/51.7c28b94d.js"><link rel="prefetch" href="/assets/js/52.b994f2a5.js"><link rel="prefetch" href="/assets/js/53.cb8ae75f.js"><link rel="prefetch" href="/assets/js/54.bed231f5.js"><link rel="prefetch" href="/assets/js/55.b5c12083.js"><link rel="prefetch" href="/assets/js/56.d24c194a.js"><link rel="prefetch" href="/assets/js/57.2266c999.js"><link rel="prefetch" href="/assets/js/58.45dbc100.js"><link rel="prefetch" href="/assets/js/59.ee7c29b0.js"><link rel="prefetch" href="/assets/js/6.f5721c6c.js"><link rel="prefetch" href="/assets/js/60.49ed42de.js"><link rel="prefetch" href="/assets/js/61.a43df18c.js"><link rel="prefetch" href="/assets/js/62.5e1da83b.js"><link rel="prefetch" href="/assets/js/63.14208060.js"><link rel="prefetch" href="/assets/js/64.6b19c853.js"><link rel="prefetch" href="/assets/js/65.ceab9cdd.js"><link rel="prefetch" href="/assets/js/66.b753dfad.js"><link rel="prefetch" href="/assets/js/67.1db0c319.js"><link rel="prefetch" href="/assets/js/68.f5f93361.js"><link rel="prefetch" href="/assets/js/69.b1ab7abf.js"><link rel="prefetch" href="/assets/js/7.8d5cc4a4.js"><link rel="prefetch" href="/assets/js/70.77a5f0d2.js"><link rel="prefetch" href="/assets/js/71.eb7e60d3.js"><link rel="prefetch" href="/assets/js/72.ce397162.js"><link rel="prefetch" href="/assets/js/73.d6d6e81e.js"><link rel="prefetch" href="/assets/js/74.b3461251.js"><link rel="prefetch" href="/assets/js/76.e2e72906.js"><link rel="prefetch" href="/assets/js/77.e136d187.js"><link rel="prefetch" href="/assets/js/78.3171be39.js"><link rel="prefetch" href="/assets/js/79.14b82bd4.js"><link rel="prefetch" href="/assets/js/8.7fa854ee.js"><link rel="prefetch" href="/assets/js/80.79b8c166.js"><link rel="prefetch" href="/assets/js/81.b2f0ea0e.js"><link rel="prefetch" href="/assets/js/82.3144efdf.js"><link rel="prefetch" href="/assets/js/83.5634923a.js"><link rel="prefetch" href="/assets/js/84.703bfdd4.js"><link rel="prefetch" href="/assets/js/85.d32675d6.js"><link rel="prefetch" href="/assets/js/86.14b93fe4.js"><link rel="prefetch" href="/assets/js/87.e5260d6a.js"><link rel="prefetch" href="/assets/js/88.46bb29a0.js"><link rel="prefetch" href="/assets/js/89.50521f1a.js"><link rel="prefetch" href="/assets/js/9.cfef67a1.js"><link rel="prefetch" href="/assets/js/90.2d1b8a1d.js"><link rel="prefetch" href="/assets/js/91.038004a9.js"><link rel="prefetch" href="/assets/js/92.5b384f19.js"><link rel="prefetch" href="/assets/js/93.3c44828a.js"><link rel="prefetch" href="/assets/js/94.02ba3e23.js"><link rel="prefetch" href="/assets/js/95.9c339ca0.js"><link rel="prefetch" href="/assets/js/96.bdf4adbb.js"><link rel="prefetch" href="/assets/js/97.18abbb4d.js"><link rel="prefetch" href="/assets/js/98.4530f6df.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cbd9db94.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.png" alt="进阶web高级前端知识体系" class="logo"> <span class="site-name can-hide">进阶web高级前端知识体系</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/rust/actix-web/" aria-current="page" class="nav-link router-link-exact-active router-link-active">actix-web</a></div><div class="nav-item"><a href="/javascript/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div> <a href="https://github.com/veaba/web-advanced-frond-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/rust/actix-web/" aria-current="page" class="nav-link router-link-exact-active router-link-active">actix-web</a></div><div class="nav-item"><a href="/javascript/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div> <a href="https://github.com/veaba/web-advanced-frond-end" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Actix-web</span> <span title="实验！" class="icon-experiment" style="display:none;"></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/actix-web/#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#welcome" class="sidebar-link">Welcome</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#什么是-actix" class="sidebar-link">什么是 Actix</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#安装" class="sidebar-link">安装</a></li></ul></li><li><a href="/rust/actix-web/#基础" class="sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#入门" class="sidebar-link">入门</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#application" class="sidebar-link">Application</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#server" class="sidebar-link">Server</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#handler-处理器" class="sidebar-link">Handler(处理器)</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#extractors-提取器" class="sidebar-link">Extractors(提取器)</a></li></ul></li><li><a href="/rust/actix-web/#高级" class="sidebar-link">高级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#error-错误" class="sidebar-link">Error 错误</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#url-dispatch" class="sidebar-link">URL Dispatch</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#requests-请求" class="sidebar-link">Requests 请求</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#responses-响应" class="sidebar-link">Responses(响应)</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#testing-测试" class="sidebar-link">Testing(测试)</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#middleware-中间器件" class="sidebar-link">Middleware 中间器件</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#static-files-静态文件" class="sidebar-link">Static Files 静态文件</a></li></ul></li><li><a href="/rust/actix-web/#协议" class="sidebar-link">协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#websocket" class="sidebar-link">Websocket</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#http-2-0" class="sidebar-link">HTTP/2.0</a></li></ul></li><li><a href="/rust/actix-web/#patterns-模式" class="sidebar-link">Patterns 模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#autoreloading-自动重载" class="sidebar-link">Autoreloading 自动重载</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#databases-数据库" class="sidebar-link">Databases 数据库</a></li></ul></li><li><a href="/rust/actix-web/#图表" class="sidebar-link">图表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#http-服务初始化" class="sidebar-link">HTTP 服务初始化</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#连接生命周期" class="sidebar-link">连接生命周期</a></li></ul></li><li><a href="/rust/actix-web/#api-文档" class="sidebar-link">API 文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust/actix-web/#actix" class="sidebar-link">actix</a></li><li class="sidebar-sub-header"><a href="/rust/actix-web/#actix-web-2" class="sidebar-link">actix-web</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content-layout"><div class="theme-default-content content__default"><h1 id="actix-web"><a href="#actix-web" class="header-anchor">#</a> Actix-web</h1> <ul><li><a href="https://actix.rs/" target="_blank" rel="noopener noreferrer">Actix-web官方<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <h3 id="welcome"><a href="#welcome" class="header-anchor">#</a> Welcome</h3> <h3>欢迎使用Actix</h3> <p>Actix 是开发带有 Rust 的 web 服务的门户，本文档将为你提供指导。</p> <p>本文档目前主要涉及<code>actix-web</code>部分，它是先前在<code>actix</code> actor 框架和<a href="https://tokio.rs/" target="_blank" rel="noopener noreferrer"><code>Tokio</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 异步 IO 系统之上构建的高级 web 框架。这是从 API 稳定性的角度来看最稳定的部分。</p> <p>如果你还没有使用 actix-web，最好从<a href="https://actix.rs/docs/getting-started" target="_blank" rel="noopener noreferrer">入门指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>开始。
如果你已经知道自己的方法，并且需要特定的信息，那么你可能需要阅读 <a href="https://docs.rs/actix-web" target="_blank" rel="noopener noreferrer">actix-web API 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（或较低级别的 <a href="https://docs.rs/actix" target="_blank" rel="noopener noreferrer">actix APO=I 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p> <h3 id="什么是-actix"><a href="#什么是-actix" class="header-anchor">#</a> 什么是 Actix</h3> <h3>Acitx 是多种集合</h3> <p>Actix 一个集合体，它的基础是一个强大的<code>actor</code>系统，用于 Rust，而<code>actix-web</code>系统最初就是在这个系统之上构建的，这是你最有可能使用的。<code>actix-web</code>给你的是一个有趣且快速的 web 开发框架。</p> <p>我们称<code>actix-web</code>为一个小型实用的框架。不管是出于什么目的，它都是一个有着一些曲折的微结构。
如果你已经是一个 <code>Rust</code> 程序员，你可能会发现自己在家很快，但即使你是来自另一种编程语言，你应该发现<code>actix-web</code>也很容易使用。</p> <p>使用<code>actix-web</code>开发的应用程序将公开包含在本机可执行文件中的 HTTP 服务器。
你可以将它放在另一个 HTTP 服务器（如 nginx）后面，也可以按原样提供服务。
即使在完全没有另一个 HTTP 服务器的情况下，<code>actix-web</code>也足够强大，能够提供 <code>HTTP 1</code>和 <code>http2</code> 支持以及 <code>SSL/TLS</code>，这对于构建准备分发的小型服务非常有用。</p> <p>最重要的是：<code>actix-web</code>运行在 Rust 1.39 或更高版本上，它可以与稳定的版本一起工作。</p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <h3>安装Rust</h3> <p>因为<code>actix-web</code>是一个 Rust 框架，所以你需要 Rust 来开始使用它。如果你还没有，我们建议你使用<code>rustup</code>来管理你的 Rust 安装。</p> <p>官方的 Rust 指南有一个很好的开始部分。我们目前至少需要 Rust1.39，所以请确保你运行<code>rustup update</code>以获得最新和最新的 Rust 版本。
特别是本指南将假设你实际运行 Rust 1.39 或更高版本。</p> <h3>安装actix-web</h3> <p>多亏了 Rust 的<code>cargo</code>管理器，你不需要显式地安装<code>actix-web</code>。相信它，就解放你自己了。对于不太可能使用 <code>actix-web</code> 开发版本的情况，可以直接依赖 git 存储库。</p> <p>发行版本：</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">actix-web</span> <span class="token punctuation">=</span> <span class="token string">&quot;2.0&quot;</span>
</code></pre></div><p>开发版本：</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">actix-web</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">git</span> <span class="token punctuation">=</span> <span class="token string">&quot;https://github.com/actix/actix-web&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><h4 id="潜入"><a href="#潜入" class="header-anchor">#</a> 潜入</h4> <p>这里有两条路可以走，你可以按照指南进行操作，或者如果你非常不耐烦，你可能希望查看我们广泛的示例存储库并运行包含的示例。例如，下面是如何运行的基本示例：</p> <div class="language-cmd extra-class"><pre class="language-text"><code>git clone https://github.com/actix/examples
cd examples/basics
cargo run
</code></pre></div><h2 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h2> <h3 id="入门"><a href="#入门" class="header-anchor">#</a> 入门</h3> <p>让我们编写我们的第一个<code>actix-web</code>应用程序！</p> <h3>Hello,world!</h3> <p>首先创建一个新的基于二进制的 Cargo 项目并切到新目录：</p> <div class="language-cmd extra-class"><pre class="language-text"><code>cargo new hello-world
cd hello-world
</code></pre></div><p>现在，通过<code>Cargo.toml</code>将<code>actix-web</code>添加到你的依赖中，包含以下内容：</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">actix-web</span> <span class="token punctuation">=</span> <span class="token string">&quot;2.0&quot;</span>
</code></pre></div><p>如果要使用 <code>#[actix_rt::main]</code>宏，必须将<code>actix-rt</code>添加到依赖项中。现在你的<code>cargo.toml</code>应该如下所示：</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">actix-web</span> <span class="token punctuation">=</span> <span class="token string">&quot;2.0&quot;</span>
<span class="token key property">actix-rt</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
</code></pre></div><p>为了实现 web 服务器，我们首先需要创建一个请求处理程序。</p> <p>请求处理程序是一个异步函数，它接受从请求（即<code>impl FromRequest</code>）中提取的零个或多个参数，并返回可转换为<code>HttpResponse</code>（即<code>impl Responder</code>）的类型：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">,</span><span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
   <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token constant">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span><span class="token punctuation">{</span>
 <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token constant">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world again!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>接下来，创建一个应用程序实例，并使用路径上的应用程序<code>route</code>和特定的 HTTP 方法注册请求处理程序。
之后，应用程序实例可以与<code>HttpServer</code>一起用于侦听传入连接。服务器接受一个应该返回应用程序工厂的函数。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
   <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span> <span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
    <span class="token class-name">App</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/again&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index2<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就这样！现在，用<code>cargo run</code>编译并运行程序。前往<code>http://localhost:8088/</code>查看结果。</p> <div class="tip custom-block"><p class="title">Note:</p><p>你可以注意到<code>#[actix_rt::main]</code>属性宏。此宏在 actix 运行时执行标记的异步函数，此宏可以标记和执行任何异步函数。</p></div><h3>使用属性宏定义路由</h3> <p>或者，你可以使用宏属性定义路由，这些属性允许你在函数上方指定路由，如下所示：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span>get<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[get(<span class="token string">&quot;/hello&quot;</span>)]</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token keyword">impl</span> <span class="token class-name">Responder</span><span class="token punctuation">{</span>
  <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hey there!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>然后可以使用<code>service()</code>注册路由：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>index3<span class="token punctuation">)</span>
</code></pre></div><p>出于一致性原因，本文档仅使用本页开头显示的显式语法。
但是，如果你更喜欢这种语法，那么你应该在任何时候声明路由时都可以随意使用它，因为它只是语法糖。</p> <p>要了解更多信息，请参阅<a href="https://docs.rs/actix-web-codegen/" target="_blank" rel="noopener noreferrer">actix-web-codegen<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3>自动重载</h3> <p>如果需要，可以在开发期间自动重新加载服务器，该服务器根据需要重新编译。
这是不必要的，但它使快速原型更方便，因为你可以看到变化立即保存。要了解如何实现这一点，请查看<a href="https://actix.rs/docs/autoreload/" target="_blank" rel="noopener noreferrer">autoreload 模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="application"><a href="#application" class="header-anchor">#</a> Application</h3> <h3>写一个应用程序</h3> <p><code>actix-web</code>提供各种原语来构建带有 Rust 的 web 服务器和应用程序。它提供路由、中间件、请求的预处理、响应的后处理等功能。</p> <p>所有<code>actix-web</code>服务器都是围绕<code>App</code>实例构建的。它用于注册资源和中间产品的路由。它还存储同一范围内所有处理程序共享的应用程序状态。</p> <p>应用程序的<code>scope</code>充当所有路由的命名空间，即特定应用程序作用域的所有路由都具有相同的 url 路径前缀。
应用程序前缀始终包含前导<code>“/”</code>斜线。如果提供的前缀不包含前导斜杠，则会自动插入。前缀应该由值路径段组成。</p> <p>对于具有 scope<code>/app</code>的应用程序，具有<code>/app</code>、<code>/app/</code>或<code>/app/test</code>路径的任何请求都将匹配；但是，路径<code>/application</code>将不匹配</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Hello world!&quot;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在本例中，带有<code>/app</code>前缀和<code>index.html</code>索引资源已创建。此资源可通过<code>/app/index.html</code> url。</p> <p>有关详细信息，请查看<a href="/rust/actix-web/#url-dispatch">URL Dispatch</a>部分。</p> <h3>State(状态)</h3> <p>应用程序状态与同一范围内的所有路由和资源共享。状态可以通过<code>web::Data&lt;T&gt;</code>提取器访问，其中<code>T</code>是状态类型。<code>State</code>也可用于中间期间。</p> <p>让我们编写一个简单的应用程序，并将应用程序名称存储在以下状态：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token comment">// 此结构表示状态</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">AppState</span> <span class="token punctuation">{</span>
  app_name<span class="token punctuation">:</span> <span class="token class-name">String</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app_name <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">.</span>app_name<span class="token punctuation">;</span> <span class="token comment">// 获取app_name</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello {}!&quot;</span><span class="token punctuation">,</span>app_name<span class="token punctuation">)</span>  <span class="token comment">// 响应app_name</span>
<span class="token punctuation">}</span>

</code></pre></div><p>并在初始化应用程序时传入状态，然后启动应用程序：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
   <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token class-name">AppState</span> <span class="token punctuation">{</span>
                app_name<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Actix-web&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>

</code></pre></div><p>可以在应用程序中注册任意数量的状态类型。</p> <h3>Shared Mutable State(状态)</h3> <p><code>HttpServer</code> 接受应用程序工厂，而不是应用程序实例。Http 服务器为每个线程构造一个应用程序实例，因此必须多次构造应用程序数据。如果要在不同线程之间共享数据，则应使用可共享对象，例如 Send+Sync。</p> <p>在内部，<code>web::Data</code>使用 Arc。因此，为了避免双圆弧，我们应该在使用<code>App::App_Data()</code>注册数据之前创建数据。</p> <p>在下面的示例中，我们将编写一个具有可变共享状态的应用程序。首先，我们定义状态并创建处理程序：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">AppStateWithCounter</span> <span class="token punctuation">{</span>
    counter<span class="token punctuation">:</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span>  <span class="token comment">// 互斥锁对于跨线程安全地进行变异是必要的</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppStateWithCounter</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span>data<span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取counter的互斥锁</span>
    <span class="token operator">*</span>counter <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// MutexGuard内的访问计数器</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Request number :{}&quot;</span><span class="token punctuation">,</span>counter<span class="token punctuation">)</span> <span class="token comment">// 响应counter</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并在应用程序中注册数据：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">:</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AppStateWithCounter</span> <span class="token punctuation">{</span>
        counter<span class="token punctuation">:</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// move counter into the closure</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">app_data</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 注册创建的数据</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8089&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>使用应用程序范围组合应用程序</h3> <p><code>web::scope()</code>方法允许设置特定的应用程序前缀。此作用域表示资源前缀，该前缀将作为资源配置添加的所有资源模式的前缀。
这可用于帮助将一组路由装载到不同的位置，而不是包含的可调用文件的作者想要的位置，同时仍然保持相同的资源名称。</p> <p>比如：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">show_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">String</span><span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/show&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>show_users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在上面的示例中，show_users 路由将具有<code>/users/show</code>而不是/show 的有效路由模式，因为应用程序的 scope 参数将位于该模式的前面。只有当 URL 路径是/users/show，并且当<code>HttpRequest.url_for</code>函数是用路由名 show_users 调用的，它将生成具有相同路径的 URL。</p> <h3>应用程序保护和虚拟主机</h3> <p>你可以将保护程序看作一个简单的函数，它接受请求对象引用并返回 true 或 false。在形式上，守卫是实现守卫特性的任何对象。<code>actix-web</code>提供了几个防护，可以查看 api 文档的<a href="https://docs.rs/actix-web/2/actix_web/guard/index.html#functions" target="_blank" rel="noopener noreferrer">函数部分<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>提供的保护之一是<code>Header</code>，它可以用作基于请求头信息的应用程序筛选器。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token string">&quot;Host&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;www.rust-lang.org&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;www&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token string">&quot;Host&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;user.rust-lang.org&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8083&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>配置</h3> <p>为了简单性和可重用性，<code>App</code>和<code>web::Scope</code>都提供了<code>configure</code>方法。此函数可用于将配置部分移动到不同的模块甚至库。例如，一些资源的配置可以移动到不同的模块。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 此功能可以位于不同的模块中</span>

<span class="token keyword">fn</span> <span class="token function-definition function">scoped_config</span><span class="token punctuation">(</span>cfg<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">ServiceConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
        <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 此功能可以位于不同的模块中</span>

<span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span>cfg<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">ServiceConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
        <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/app&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>scoped_config<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8084&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述示例的结果是：</p> <div class="language-txt extra-class"><pre class="language-text"><code>/         -&gt; &quot;/&quot;
/app      -&gt; &quot;app&quot;
/api/test -&gt; &quot;test&quot;

</code></pre></div><p>每个<a href="https://docs.rs/actix-web/2/actix_web/web/struct.ServiceConfig.html" target="_blank" rel="noopener noreferrer"><code>ServiceConfig</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>都可以拥有自己的<code>data</code>、<code>routes</code>和<code>service</code>。</p> <h3 id="server"><a href="#server" class="header-anchor">#</a> Server</h3> <p><a href="https://docs.rs/actix-web/2/actix_web/struct.HttpServer.html" target="_blank" rel="noopener noreferrer">HttpServer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类型负责为 http 请求提供服务</p> <p><code>HttpServe</code>r 接受应用程序工厂作为参数，应用程序工厂必须具有<code>Send</code>+<code>Sync</code>边界。在 <em>“多线程”</em> 部分中详细介绍。</p> <p>若要绑定到特定的套接字地址，必须使用 bind()，并且可以多次调用它。若要绑定 ssl 套接字，应使用<code>bind_openssl()</code>或<code>bind_rustls()</code>。要运行 http 服务器，请使用<code>httpServer::run()</code>方法。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>run()</code>方法返回<a href="https://docs.rs/actix-web/2/actix_web/dev/struct.Server.html" target="_blank" rel="noopener noreferrer"><code>Server</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类型的实例。服务器类型的方法可用于管理 http 服务器</p> <ul><li><code>pause()</code> - 暂停接受传入连接</li> <li><code>resume()</code> - 继续接受传入连接</li> <li><code>stop()</code> - 停止传入连接处理，停止所有 worker 并退出</li></ul> <p>下面的示例演示如何在单独的线程中启动 http 服务器。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_rt<span class="token punctuation">::</span></span><span class="token class-name">System</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span>mpsc<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> sys <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;http-server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> srv <span class="token operator">=</span> <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">shutdown_timeout</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">// &lt;-将关机超时设置为60秒</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> _ <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sys<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> srv <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 暂停接受新连接</span>
    srv<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token comment">// 继续接受新连接</span>
    srv<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token comment">// 关停服务器</span>
    srv<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="多线程"><a href="#多线程" class="header-anchor">#</a> 多线程</h4> <p>HttpServer<code>会自动启动一些http工作进程，默认情况下，这个数目等于系统中逻辑cpu的数目。这个数字可以用</code>HttpServer::workers()`方法覆盖。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">workers</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- Start 4 workers</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建工作线程后，它们各自接收一个单独的应用程序实例来处理请求。应用程序状态不在线程之间共享，处理程序可以自由地操作其状态副本，而不涉及并发问题。</p> <p>应用程序状态不需要<code>send</code>或<code>sync</code>，但应用程序工厂必须是<code>send</code>+<code>sync</code>。</p> <p>要在工作线程之间共享状态，请使用<code>Arc</code>。一旦引入共享和同步，就应该特别小心。在许多情况下，由于锁定共享状态以进行修改，会无意中引入性能成本。</p> <p>在某些情况下，可以使用更有效的锁定策略来降低这些成本，例如使用<code>读/写锁</code>而不是互斥锁来实现非排他锁定，但是性能最高的实现往往是根本不发生锁定的实现。</p> <p>由于每个工作线程按顺序处理其请求，因此阻止当前线程的处理程序将导致当前工作线程停止处理新请求：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">my_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 坏习惯！将导致当前工作线程挂起！</span>
    <span class="token string">&quot;response&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>因此，任何长的、非 cpu 限制的操作（如 I/O、数据库操作等）都应表示为未来函数或异步函数。异步处理程序由工作线程并发执行，因此不会阻止执行：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">my_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">delay_for</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- OK! 工作线程将在此处理其他请求</span>
    <span class="token string">&quot;response&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样的限制也适用于提取器。当处理程序函数接收到实现<code>FromRequest</code>的参数，并且该实现阻塞当前线程时，工作线程将在运行处理程序时阻塞。出于这个原因，在实现提取器时必须特别注意，而且在需要时也应该异步实现提取器。</p> <h4 id="ssl"><a href="#ssl" class="header-anchor">#</a> SSL</h4> <p>ssl 服务器有两个特性：<code>rustls</code>和<code>openssl</code>。<code>rustls</code>特性用于<code>rustls</code>集成，<code>openssl</code>用于<code>openssl</code>。</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">actix-web</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;openssl&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token key property">openssl</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span><span class="token punctuation">=</span><span class="token string">&quot;0.10&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">openssl<span class="token punctuation">::</span>ssl<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">SslAcceptor</span><span class="token punctuation">,</span> <span class="token class-name">SslFiletype</span><span class="token punctuation">,</span> <span class="token class-name">SslMethod</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>_req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Welcome!&quot;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// load ssl keys</span>
    <span class="token comment">// to create a self-signed temporary cert for testing:</span>
    <span class="token comment">// `openssl req -x509 -newkey rsa:4096 -nodes -keyout key.pem -out cert.pem -days 365 -subj '/CN=localhost'`</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> builder <span class="token operator">=</span>
        <span class="token class-name">SslAcceptor</span><span class="token punctuation">::</span><span class="token function">mozilla_intermediate</span><span class="token punctuation">(</span><span class="token class-name">SslMethod</span><span class="token punctuation">::</span><span class="token function">tls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder
        <span class="token punctuation">.</span><span class="token function">set_private_key_file</span><span class="token punctuation">(</span><span class="token string">&quot;key.pem&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SslFiletype</span><span class="token punctuation">::</span><span class="token constant">PEM</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">set_certificate_chain_file</span><span class="token punctuation">(</span><span class="token string">&quot;cert.pem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind_openssl</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="title">Note:</p><p>the HTTP/2.0 protocol requires tls alpn. At the moment, only openssl has alpn support. For a full example, check out <a href="https://github.com/actix/examples/blob/master/openssl" target="_blank" rel="noopener noreferrer">examples/openssl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div><p>创建<code>key.pem</code>以及<code>cert.pem</code>使用命令。填写你自己的主题</p> <div class="language-shell extra-class"><pre class="language-shell"><code>
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem <span class="token punctuation">\</span>
  -days <span class="token number">365</span> -sha256 -subj <span class="token string">&quot;/C=CN/ST=Fujian/L=Xiamen/O=TVlinux/OU=Org/CN=muro.lxd&quot;</span>

</code></pre></div><p>要删除密码，请复制<code>nopass.pem</code>到<code>cert.pem</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>openssl rsa -in key.pem -out nopass.pem
</code></pre></div><h4 id="keep-alive"><a href="#keep-alive" class="header-anchor">#</a> Keep-Alive</h4> <p>Actix 可以在保持活动连接上等待请求。</p> <p><em><code>keep-alive</code></em> 连接行为由服务器设置定义。</p> <ul><li><code>75</code>, <code>Some(75)</code>, <code>KeepAlive::Timeout(75)</code> - 启用 75 秒<em>keep alive</em>计时器</li> <li><code>None</code> or <code>KeepAlive::Disabled</code> - 禁用 <em>keep alive</em></li> <li><code>KeepAlive::Tcp(75)</code> - 使用<code>SO_KEEPALIVE</code> socket 选项</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpReesponse</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> one <span class="token operator">=</span><span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keep_alive</span><span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置keep-alive 75s</span>
    <span class="token keyword">let</span> _three <span class="token operator">=</span><span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keep_alive</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 禁用keep-alive</span>
    one<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果选择了上面的第一个选项，那么将根据响应的连接类型计算保持活动状态。默认情况下，未定义<code>HttpResponse::connection_type</code>。在这种情况下，keep alive 由请求的 http 版本定义。</p> <p>对于 HTTP/1.0，<em>keep alive</em>处于关闭状态；对于 HTTP/1.1 和 HTTP/2.0，<em>keep alive</em>处于打开状态。</p> <p>可以使用<code>HttpResponseBuilder::Connection_type()</code>方法更改连接类型。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>http<span class="token punctuation">,</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>

    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connection_type</span><span class="token punctuation">(</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ConnectionType</span><span class="token punctuation">::</span><span class="token class-name">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 关闭连接</span>
        <span class="token punctuation">.</span><span class="token function">force_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 替代方法</span>
        <span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="平滑关闭"><a href="#平滑关闭" class="header-anchor">#</a> 平滑关闭</h4> <p><code>HttpServer</code>支持正常关机。在收到停止信号后，工作人员有一定的时间来完成服务请求。
超时后仍活着的工人将被强制放弃。默认情况下，关闭超时设置为 30 秒。可以使用<code>HttpServer::shutdown_timeout()</code>方法更改此参数。</p> <p>你可以使用服务器地址向服务器发送停止消息，并指定是否要正常关机, <code>start()</code>方法返回服务器的地址。</p> <p><code>HttpServer</code>处理多个操作系统信号。<em>CTRL-C</em>可用于所有操作系统，其他信号可用于 unix 系统。</p> <ul><li><em>SIGINT</em> - 强制关闭 workers</li> <li><em>SIGTERM</em> - 平滑关闭 workers</li> <li><em>SIGQUIT</em> - 强制关闭 workers</li></ul> <p>可以使用<code>HttpServer::disable_signals()</code>方法禁用信号处理</p> <h3 id="handler-处理器"><a href="#handler-处理器" class="header-anchor">#</a> Handler(处理器)</h3> <p>请求处理程序是一个异步函数，它接受可以从请求（即<a href="https://docs.rs/actix-web/2/actix_web/trait.FromRequest.html" target="_blank" rel="noopener noreferrer"><em>impl FromRequest</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）提取的零个或多个参数，并返回可以转换为 HttpResponse（即 <a href="https://docs.rs/actix-web/2/actix_web/trait.Responder.html" target="_blank" rel="noopener noreferrer"><em>impl Responder</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）的类型。</p> <p>请求处理分两个阶段进行。首先调用处理程序对象，返回实现<a href="https://docs.rs/actix-web/2/actix_web/trait.Responder.html" target="_blank" rel="noopener noreferrer"><code>*Responder*</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>特性的任何对象。然后，对返回的对象调用<code>respond_to()</code>，将其自身转换为<code>HttpResponse</code>或<code>Error</code>。</p> <p>默认情况下，actix-web 为某些标准类型（如&amp;'static str、String 等）提供响应程序实现。</p> <p>有关实现的完整列表，请查看<a href="https://docs.rs/actix-web/2/actix_web/trait.Responder.html#foreign-impls" target="_blank" rel="noopener noreferrer"><em>Responder</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 文档。</p> <p>有效处理程序示例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">{</span>
    <span class="token string">&quot;Hello world!&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">{</span>
    <span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>你还可以更改签名以返回<code>impl Responder</code>，如果涉及到更复杂的类型，则该签名可以正常工作。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">b&quot;Hello world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">=</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">=</span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="定制响应类型"><a href="#定制响应类型" class="header-anchor">#</a> 定制响应类型</h4> <p>若要直接从处理程序函数返回自定义类型，该类型需要实现<code>Responder</code>特性。</p> <p>让我们为序列化为<code>application/json</code>响应的自定义类型创建一个响应：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Error</span><span class="token punctuation">,</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span><span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Serialize</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>future<span class="token punctuation">::</span></span><span class="token punctuation">{</span>ready<span class="token punctuation">,</span> <span class="token class-name">Ready</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Serialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyObj</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Responder</span>
<span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token keyword">for</span> <span class="token class-name">MyObj</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Future</span> <span class="token operator">=</span> <span class="token class-name">Ready</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">respond_to</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> _req<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Future</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create response and set content type</span>
        <span class="token function">ready</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">content_type</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token keyword">impl</span> <span class="token class-name">Responder</span><span class="token punctuation">{</span>
    <span class="token class-name">MyObj</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">&quot;Hello user&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="流式响应体"><a href="#流式响应体" class="header-anchor">#</a> 流式响应体</h4> <p>响应体可以异步生成。在这种情况下，body 必须实现流特征 <code>Stream&lt;Item=Bytes，Error=Error&gt;</code>，即：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">bytes<span class="token punctuation">::</span></span><span class="token class-name">Bytes</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>stream<span class="token punctuation">::</span></span>once<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>future<span class="token punctuation">::</span></span>ok<span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">::</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">b&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">content_type</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">streaming</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/async&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="不同的返回类型-任意一种"><a href="#不同的返回类型-任意一种" class="header-anchor">#</a> 不同的返回类型（任意一种）</h4> <p>有时，你需要返回不同类型的响应。例如，可以进行错误检查并返回错误、返回异步响应或任何需要两种不同类型的结果。</p> <p>在这种情况下，<a href="https://docs.rs/actix-web/2/actix_web/enum.Either.html" target="_blank" rel="noopener noreferrer">两种<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类型都可以使用。允许将两个不同的响应程序类型合并为一个类型。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Either</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">RegisterResult</span> <span class="token operator">=</span> <span class="token class-name">Either</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RegisterResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">is_a_variant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;- choose variant A</span>
        <span class="token class-name">Either</span><span class="token punctuation">::</span><span class="token class-name">A</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">BadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Bad data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;- variant B</span>
        <span class="token class-name">Either</span><span class="token punctuation">::</span><span class="token class-name">B</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="extractors-提取器"><a href="#extractors-提取器" class="header-anchor">#</a> Extractors(提取器)</h3> <p><code>Actix-web</code>为类型安全的请求信息访问提供了一个称为提取器的工具（即 impl FromRequest）。默认情况下，<code>actix-web</code>提供了几个提取器实现。</p> <p>提取器可以作为处理程序函数的参数访问。<code>Actix-web</code>支持每个处理函数最多 10 个提取器，参数的位置无关紧要。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    path <span class="token punctuation">:</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    json<span class="token punctuation">:</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Json</span><span class="token punctuation">(</span><span class="token class-name">MyInfo</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{} {} {} {}&quot;</span><span class="token punctuation">,</span>path<span class="token number">.0</span><span class="token punctuation">,</span>path<span class="token number">.1</span><span class="token punctuation">,</span>path<span class="token punctuation">.</span>id<span class="token punctuation">,</span>json<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="path"><a href="#path" class="header-anchor">#</a> Path</h4> <p><a href="https://docs.rs/actix-web/2/actix_web/dev/struct.Path.html" target="_blank" rel="noopener noreferrer"><code>*Path*</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>提供可以从请求路径提取的信息。可以反序列化路径中的任何变量段。</p> <p>例如，对于为<code>/users/{userid}/{friend}</code>路径注册的资源，可以反序列化两个段：<code>userid</code>和<code>friend</code>。这些段可以被提取到<code>tuple</code>中，即<code>Path&lt;（u32，String）&gt;</code>或任何实现<em>serde</em> crate<code>反序列化</code>特性的结构中。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// extract path info from &quot;/users/{userid}/{friend}&quot; url</span>
<span class="token comment">/// {userid} -  - deserializes to a u32</span>
<span class="token comment">/// {friend} - deserializes to a String</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}, userid {}!&quot;</span><span class="token punctuation">,</span> info<span class="token number">.1</span><span class="token punctuation">,</span> info<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/users/{userid}/{friend}&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- define path parameters</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还可以将路径信息提取到实现<em>serde</em><code>反序列化</code>特性的特定类型。下面是一个使用<em>serde</em>而不是<em>tuple</em>类型的等效示例。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    userid<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    friend<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// extract path info using serde</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}, userid {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>friend<span class="token punctuation">,</span> info<span class="token punctuation">.</span>userid<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/users/{userid}/{friend}&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- define path parameters</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还可以按名称<code>get</code>或<code>query</code>路径参数请求:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span>
        req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;friend&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> userid<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}, userid {}!&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> userid<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/users/{userid}/{friend}&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- define path parameters</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="query"><a href="#query" class="header-anchor">#</a> Query</h4> <p><a href="https://docs.rs/actix-web/2/actix_web/web/struct.Query.html" target="_blank" rel="noopener noreferrer"><em><code>查询</code></em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类型为请求的查询参数提供提取功能。下面使用的是<em>serde_urlencoded</em><code>crate</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span>web<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// this handler get called only if the request's query contains `username` field</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Query</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="json"><a href="#json" class="header-anchor">#</a> Json</h4> <p><a href="https://docs.rs/actix-web/2/actix_web/web/struct.Json.html" target="_blank" rel="noopener noreferrer"><em>Json</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许将请求体反序列化为结构。要从请求体中提取类型化信息，类型<code>T</code>必须实现<em>serde</em>的<code>反序列化</code>特性。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// deserialize `Info` from request's body</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Json</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>一些提取器提供了配置提取过程的方法。用于配置的Json提取器<a href="https://docs.rs/actix-web/2/actix_web/web/struct.JsonConfig.html" target="_blank" rel="noopener noreferrer"><em>JsonConfig</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类型。要配置提取器，请将其配置对象传递给资源的<code>.data()</code>方法。如果是Json提取器，则返回<em>JsonConfig</em>。你可以配置json负载的最大大小以及自定义错误处理程序函数。</p> <p>下面的示例将负载大小限制为4kb，并使用自定义错误处理程序。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">FromRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// deserialize `Info` from request's body, max payload size is 4kb</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Json</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// change json extractor configuration</span>
                <span class="token punctuation">.</span><span class="token function">app_data</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Json</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>cfg<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    cfg<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error_handler</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token punctuation">,</span> _req<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                        <span class="token comment">// create custom error response</span>
                        <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">InternalError</span><span class="token punctuation">::</span><span class="token function">from_response</span><span class="token punctuation">(</span>
                            err<span class="token punctuation">,</span>
                            <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Conflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="form"><a href="#form" class="header-anchor">#</a> Form</h4> <p>目前，只支持url编码的表单。url编码的正文可以提取到特定类型。此类型必须实现<em>serde</em> crate 的<code>反序列化</code>特性。</p> <p><a href="https://docs.rs/actix-web/2/actix_web/web/struct.FormConfig.html" target="_blank" rel="noopener noreferrer"><em>FormConfig</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许配置提取过程。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FormData</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// extract form data using serde</span>
<span class="token comment">/// this handler gets called only if the content type is *x-www-form-urlencoded*</span>
<span class="token comment">/// and the content of the request could be deserialized to a `FormData` struct</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>form<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Form</span><span class="token operator">&lt;</span><span class="token class-name">FormData</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> form<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="other"><a href="#other" class="header-anchor">#</a> Other</h4> <p><code>Actix-web</code>还提供了其他几个提取器：</p> <ul><li><a href="https://docs.rs/actix-web/2/actix_web/web/struct.Data.html" target="_blank" rel="noopener noreferrer"><em>Data</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - 如果需要访问应用程序状态。</li> <li><code>HttpRequest</code> - 本身是一个提取器，它返回self，以防需要访问请求。</li> <li><code>String</code> - 你可以将请求的负载转换为<code>String</code>,<a href="https://docs.rs/actix-web/2/actix_web/trait.FromRequest.html#example-2" target="_blank" rel="noopener noreferrer">示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在文档字符串中可用。</li> <li><code>bytes::Bytes</code> -你可以将请求的负载转换为<code>Bytes</code>,<a href="https://docs.rs/actix-web/2/actix_web/trait.FromRequest.html#example-4" target="_blank" rel="noopener noreferrer">示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>在文档字符串中可用。</li> <li><code>Payload</code> -你可以访问请求的有效负载,<a href="https://docs.rs/actix-web/2/actix_web/web/struct.Payload.html" target="_blank" rel="noopener noreferrer">示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="应用程序状态提取器"><a href="#应用程序状态提取器" class="header-anchor">#</a> 应用程序状态提取器</h4> <p>使用<code>web::Data</code>提取器可以从处理程序访问应用程序状态；但是，可以将状态作为只读引用访问。如果需要对状态的可变访问，则必须实现它。</p> <p>::: waring 小心
actix会创建应用程序状态和处理程序的多个副本。它为每个线程创建一个副本。
:::</p> <p>以下是存储已处理请求数的处理程序示例:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">Cell</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">AppState</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">show_count</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_one</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token class-name">AppState</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token class-name">Cell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>show_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>add_one<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>

</code></pre></div><p>尽管此处理程序可以工作，但<code>self.0</code>将根据线程数和每个线程处理的请求数而有所不同。正确的实现将使用<code>Arc</code>和<code>AtomicUsize</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Arc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">AppState</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">AtomicUsize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">show_count</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_one</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;count: {}&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token class-name">AppState</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>show_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>add_one<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意同步原语，如<code>Mutex</code>或<code>RwLock</code>,<code>actix-web</code>框架异步处理请求。通过阻塞线程执行，所有并发请求处理进程都将阻塞。如果需要从多个线程共享或更新某些状态，请考虑使用tokio同步原语。</p> <h2 id="高级"><a href="#高级" class="header-anchor">#</a> 高级</h2> <h3 id="error-错误"><a href="#error-错误" class="header-anchor">#</a> Error 错误</h3> <p><code>Actix-web</code>使用自己的<code>Actix-web::error::error</code> type和<code>Actix-web::error::ResponseError</code>特性从web处理程序处理错误。</p> <p>如果处理程序在还实现<code>ResponseError</code>特征的结果中返回<code>Error</code>（指一般的<a href="https://doc.rust-lang.org/std/error/trait.Error.html" target="_blank" rel="noopener noreferrer">Rust trait std::Error::Error<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），<code>actix-web</code>将该错误呈现为HTTP响应，其对应的<code>actix_web::HTTP::StatusCode</code>，默认情况下生成内部服务器错误：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> train <span class="token class-name">ResponseError</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">error_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">status_code</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token class-name">StatusCode</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>Responder</code>程序将兼容<code>结果</code>强制为HTTP响应：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span><span class="token class-name">Responder</span><span class="token punctuation">,</span><span class="token class-name">E</span><span class="token punctuation">:</span><span class="token class-name">Into</span><span class="token operator">&lt;</span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token class-name">Responder</span> <span class="token keyword">for</span> <span class="token class-name">Result</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">E</span><span class="token operator">&gt;</span>
</code></pre></div><p>上面代码中的<code>Error</code>是<code>actix-web</code>的错误定义，任何实现<code>ResponseError</code>的错误都可以自动转换为一个错误。</p> <p><code>Actix-web</code>为一些常见的非Actix错误提供<code>ResponseError</code>实现。例如，如果处理程序以<code>io::Error</code>响应，则该错误将转换为<code>HttpInternalServerError</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span><span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">NameFile</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">NameFile</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;static/index.html&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请参阅<a href="https://docs.rs/actix-web/2/actix_web/error/trait.ResponseError.html#foreign-impls" target="_blank" rel="noopener noreferrer">actix-web API文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，以获取<code>ResponseError</code>的外部实现的完整列表。</p> <h4 id="自定义错误响应的示例"><a href="#自定义错误响应的示例" class="header-anchor">#</a> 自定义错误响应的示例</h4> <p>下面是<code>ResponseError</code>的一个实现示例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span><span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">failure<span class="token punctuation">::</span></span><span class="token class-name">Fail</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive]</span><span class="token punctuation">(</span><span class="token class-name">Fail</span><span class="token punctuation">,</span><span class="token class-name">Debug</span><span class="token punctuation">)</span>
<span class="token attribute attr-name">#[fail(display=<span class="token string">&quot;my error&quot;</span>)]</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyError</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对`error_response()` 方法使用默认实现</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span><span class="token class-name">MyError</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">MyError</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ResponseError</code>有一个<code>error_response()</code>的默认实现，它将呈现一个500（内部服务器错误），当上面的<code>index</code>处理程序执行时，就会发生这种情况。</p> <p>重写<code>error_response()</code>以生成更有用的结果：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_http<span class="token punctuation">::</span></span><span class="token class-name">ResonderBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span><span class="token namespace">http<span class="token punctuation">::</span></span>header<span class="token punctuation">,</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">failure<span class="token punctuation">::</span></span><span class="token class-name">Fail</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Fail,Debug)]</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">MyError</span><span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[fail(display=<span class="token string">&quot;internal error&quot;</span>)]</span>
    <span class="token class-name">InternalError</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[fail(display=<span class="token string">&quot;bad request&quot;</span>)]</span>
    <span class="token class-name">BadClientData</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[fail(display=<span class="token string">&quot;timeout&quot;</span>)]</span>
    <span class="token class-name">Timeout</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ResponseError</span> <span class="token keyword">for</span> <span class="token class-name">MyError</span><span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">error_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">status_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set_header</span><span class="token punctuation">(</span><span class="token namespace">header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span><span class="token string">&quot;text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">status_code</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">StatusCode</span><span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">{</span>
            <span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">InternalError</span> <span class="token operator">=&gt;</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
            <span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">BadClientData</span> <span class="token operator">=&gt;</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">,</span>
            <span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">Timeout</span> <span class="token operator">=&gt;</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">GATEWAY_TIMEOUT</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span><span class="token class-name">MyError</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">BadClientData</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="error帮助器"><a href="#error帮助器" class="header-anchor">#</a> Error帮助器</h4> <p><code>Actix-web</code>提供了一组错误助手函数，这些函数对于从其他错误生成特定的HTTP错误代码非常有用。在这里，我们使用<code>map_err</code>将未实现<code>ResponseError</code>特性的<code>MyError</code>转换为 <em>400</em> （错误请求）：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span><span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyError</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result<span class="token punctuation">:</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span><span class="token class-name">MyError</span><span class="token operator">&gt;=</span><span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">MyError</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">&quot;test Error!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">map_errz</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span><span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ErrorBadRequest</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>有关可用错误帮助程序的完整列表，请参阅<a href="https://docs.rs/actix-web/2/actix_web/error/struct.Error.html" target="_blank" rel="noopener noreferrer">actix-web错误模块的API文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="故障兼容"><a href="#故障兼容" class="header-anchor">#</a> 故障兼容</h4> <p><code>Actix-web</code>提供了与故障库的自动兼容性，因此派生失败的<code>错误</code>将自动转换为Actix错误。请记住，除非你还为这些错误提供了自己的<code>error_response()</code>实现，否则这些错误将以默认的<em>500</em>状态代码呈现。</p> <h4 id="错误日志"><a href="#错误日志" class="header-anchor">#</a> 错误日志</h4> <p>Actix在<code>WARN</code>日志级别记录所有错误。如果应用程序的日志级别设置为“<code>调试</code>”，并且启用了<code>RUST_BACKTRACE</code>，则也会记录该回溯。这些是可配置的环境变量：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token operator">&gt;&gt;</span> <span class="token assign-left variable">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">RUST_LOG</span><span class="token operator">=</span>actix_web<span class="token operator">=</span>debug cargo run
</code></pre></div><p><code>Error</code>类型使用原因的错误回溯（如果可用）。如果基础故障不提供回溯，则会构造一个新的回溯，指向发生转换的点（而不是错误的来源）。</p> <h4 id="错误处理的推荐实践"><a href="#错误处理的推荐实践" class="header-anchor">#</a> 错误处理的推荐实践</h4> <p>考虑将应用程序产生的错误分成两大类可能是有用的：一类是面向用户的错误，另一类不是面向用户的错误。</p> <p>前者的一个例子是，我可能使用failure指定一个<code>UserError</code>枚举，该枚举封装了<code>ValidationError</code>，以便在用户发送错误输入时返回：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_http<span class="token punctuation">::</span></span><span class="token class-name">ResponseBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span><span class="token namespace">http<span class="token punctuation">::</span></span>header<span class="token punctuation">,</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">failure<span class="token punctuation">::</span></span><span class="token class-name">Fail</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Fail,Debug)]</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">UserError</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[fail(display =<span class="token string">&quot;Validation error on field:{}&quot;</span>,field)]</span>
    <span class="token class-name">ValidationError</span><span class="token punctuation">(</span>field<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>   

<span class="token keyword">impl</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ResponseError</span> <span class="token keyword">for</span> <span class="token class-name">UserError</span> <span class="token punctuation">{</span>
     <span class="token keyword">fn</span> <span class="token function-definition function">error_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">status_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set_header</span><span class="token punctuation">(</span><span class="token namespace">header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html; charset=utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">status_code</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">StatusCode</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">UserError</span><span class="token punctuation">::</span><span class="token class-name">ValidationError</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>这将完全按照预期操作，因为使用<code>display</code>定义的错误消息是以用户要读取的明确意图编写的。</p> <p>然而，对于所有的错误来说，回发错误消息并不可取——在服务器环境中，可能会发生许多错误，我们可能希望在其中向用户隐藏细节。
例如，如果数据库关闭，客户端库开始产生连接超时错误，或者HTML模板的格式不正确，并且在呈现时出错。在这些情况下，最好将错误映射到适合用户使用的通用错误。</p> <p>下面是一个将内部错误映射到带有自定义消息的面向用户的<code>InternalError</code>的示例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_http<span class="token punctuation">::</span></span><span class="token class-name">ResponseBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span>header<span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">failure<span class="token punctuation">::</span></span><span class="token class-name">Fail</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Fail, Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">UserError</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[fail(display = <span class="token string">&quot;An internal error occurred. Please try again later.&quot;</span>)]</span>
    <span class="token class-name">InternalError</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ResponseError</span> <span class="token keyword">for</span> <span class="token class-name">UserError</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">error_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">status_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set_header</span><span class="token punctuation">(</span><span class="token namespace">header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html; charset=utf-8&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">status_code</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">StatusCode</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">UserError</span><span class="token punctuation">::</span><span class="token class-name">InternalError</span> <span class="token operator">=&gt;</span> <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">UserError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">do_thing_that_failes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_e<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">UserError</span><span class="token punctuation">::</span><span class="token class-name">InternalError</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">&quot;success!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过将错误分为面向用户的错误和不面向用户的错误，我们可以确保不会意外地将用户暴露在应用程序内部抛出的错误中，而这些错误是他们不想看到的。</p> <h4 id="错误日志-2"><a href="#错误日志-2" class="header-anchor">#</a> 错误日志</h4> <p>这是一个使用<code>middleware::Logger</code>的基本示例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">failure<span class="token punctuation">::</span></span><span class="token class-name">Fail</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">log<span class="token punctuation">::</span></span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Fail, Debug)]</span>
<span class="token attribute attr-name">#[fail(display = <span class="token string">&quot;my error&quot;</span>)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MyError</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Use default implementation for `error_response()` method</span>
<span class="token keyword">impl</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ResponseError</span> <span class="token keyword">for</span> <span class="token class-name">MyError</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">MyError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> err <span class="token operator">=</span> <span class="token class-name">MyError</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;test error&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token macro property">debug!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Logger</span><span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span><span class="token function">set_var</span><span class="token punctuation">(</span><span class="token string">&quot;RUST_LOG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;my_errors=debug,actix_web=info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span><span class="token function">set_var</span><span class="token punctuation">(</span><span class="token string">&quot;RUST_BACKTRACE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">env_logger<span class="token punctuation">::</span></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Logger</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="url-dispatch"><a href="#url-dispatch" class="header-anchor">#</a> URL Dispatch</h3> <p>URL分派提供了一种简单的方法，可以使用简单的模式匹配语言将URL映射到处理程序代码。如果其中一个模式匹配与请求关联的路径信息，则调用特定的处理程序对象。</p> <p>请求处理程序是一个函数，它接受可以从请求（即<a href="https://docs.rs/actix-web/2/actix_web/trait.FromRequest.html" target="_blank" rel="noopener noreferrer"><em>impl FromRequest</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）提取的零个或多个参数，并返回可以转换为HttpResponse（即<a href="https://docs.rs/actix-web/2/actix_web/trait.Responder.html" target="_blank" rel="noopener noreferrer"><em>impl Responder</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）的类型。<a href="https://actix.rs/docs/handlers/" target="_blank" rel="noopener noreferrer">处理程序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>部分提供了更多信息。</p> <h4 id="资源配置"><a href="#资源配置" class="header-anchor">#</a> 资源配置</h4> <p>资源配置是向应用程序添加新资源的行为。资源有一个名称，它充当用于生成URL的标识符。该名称还允许开发人员向现有资源添加路由。
资源也有一个模式，用于与URL的<code>path</code>部分（scheme和port后面的部分，例如<code>URL</code>中的<code>/foo/bar</code>）匹配<code>http://localhost:8080/foo/bar?q=value</code>）。
它与查询部分不匹配（后面的部分？，例如，<code>q=value</code>在 <code>http://localhost:8080/foo/bar?q=value</code>）。</p> <p><code>App::route()</code>方法提供了注册路由的简单方法。此方法将单个路由添加到应用程序路由表。此方法接受路径模式、http方法和处理程序函数。对于同一个路径，可以多次调用route()方法，在这种情况下，多个路由为同一个资源路径注册。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8084&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>

</code></pre></div><p>虽然*App::route()*提供了注册路由的简单方法，但要访问完整的资源配置，必须使用不同的方法。<code>App::service()</code>方法将单个<a href="https://docs.rs/actix-web/2/actix_web/struct.Resource.html" target="_blank" rel="noopener noreferrer">resource<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>添加到应用程序路由表中。此方法接受路径模式、保护和一个或多个路径</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>guard<span class="token punctuation">,</span>web<span class="token punctuation">,</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-&gt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/prefix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;user_detail&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>如果资源不包含任何路由或没有任何匹配的路由，则返回<code>NOT FOUND</code>的http响应。</p> <h4 id="配置一个路由"><a href="#配置一个路由" class="header-anchor">#</a> 配置一个路由</h4> <p>资源包含一组路由。每条路线依次有一组<code>guards</code>和一个处理器。可以使用<code>Resource::route()</code>方法创建新路由，该方法返回对新路由实例的引用。默认情况下，路由不包含任何保护，因此匹配所有请求，默认处理程序为：<code>HttpNotFound</code>。</p> <p>应用程序根据在资源注册和路由注册期间定义的路由条件路由传入请求。资源匹配它包含的所有路由，其顺序为通过<code>Resource::route()</code>注册路由的顺序。</p> <p>一个路由可以包含任意数量的守卫，但只能包含一个处理程序。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
    <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
        <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">gurad<span class="token punctuation">::</span></span><span class="token class-name">Header</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>在本例中，如果GET请求包含<code>Content-Type</code>头，则返回<code>HttpResponse::Ok()</code>，该头的值为text/plain，路径等于<code>/path</code>。</p> <p>如果资源无法匹配任何路由，则返回“<code>NOT FOUND</code>”响应。</p> <p><code>ResourceHandler::route()</code>返回路由对象。可以使用类似于生成器的模式配置路由。以下配置方法可用：</p> <ul><li><code>Route::guard()</code>      - 注册一个新的guard。每条路线可登记任何数量的守卫。</li> <li><code>Route::method()</code>     - 注册方法保护程序。每条路线可登记任何数量的守卫。</li> <li><code>Route::to()</code>         - 为此路由注册处理程序函数。只能注册一个处理程序。通常，处理程序注册是最后一个配置操作。</li> <li><code>Route::to_async()</code>   - 为此路由注册一个异步处理程序函数。只能注册一个处理程序。处理程序注册是最后一个配置操作。</li></ul> <h4 id="路由匹配"><a href="#路由匹配" class="header-anchor">#</a> 路由匹配</h4> <p>路由配置的主要目的是根据URL路径模式匹配（或不匹配）请求的<code>path</code>,<code>path</code>表示请求的URL的路径部分。</p> <p><code>actix-web</code> 做这件事的方式非常简单。当请求进入系统时，对于系统中存在的每个资源配置声明，actix会根据声明的模式检查请求的路径。
此检查按通过<code>App::service()</code>方法声明路由的顺序进行。如果找不到资源，则使用默认资源作为匹配的资源。</p> <p>声明路由配置时，它可能包含路由保护参数。与路由声明关联的所有路由保护必须为<code>true</code>，才能在检查期间将路由配置用于给定请求。
如果提供给路由配置的路由保护参数集中的任何保护在检查期间返回<code>false</code>，则跳过该路由，并继续通过有序的路由集进行路由匹配。</p> <p>如果任何路由匹配，则停止路由匹配进程并调用与该路由关联的处理程序。如果在用尽所有路由模式后没有匹配的路由，则返回一个<code>NOT FOUND</code>的响应。</p> <h4 id="资源模式语法"><a href="#资源模式语法" class="header-anchor">#</a> 资源模式语法</h4> <p>actix在pattern参数中使用的模式匹配语言的语法很简单。</p> <p>路由配置中使用的模式可以以斜线字符开头。如果模式不是以斜杠字符开头，则在匹配时会在其前面加上一个隐式斜杠。例如，以下模式是等效的：</p> <div class="language-text extra-class"><pre class="language-text"><code>{foo}/bar/baz
</code></pre></div><p>和</p> <div class="language-text extra-class"><pre class="language-text"><code>/{foo}/bar/baz
</code></pre></div><p>变量部分（替换标记）以<code>{identifier}</code>的形式指定，这里的意思是“接受下一个斜杠字符之前的任何字符，并将其用作<code>HttpRequest.match_info()</code>对象”。</p> <p>模式中的替换标记与正则表达式<code>[^{}/]</code>+匹配。</p> <p><code>match_info</code>是<code>Params</code>对象，表示根据路由模式从URL提取的动态部分。它可用作请求匹配信息. 例如，以下模式定义了一个文本段（<code>foo</code>）和两个替换标记（<code>baz</code>和<code>bar</code>）：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/{baz}/{bar}
</code></pre></div><p>上述模式将匹配这些url，并生成以下匹配信息：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/1/2        -&gt; Params {'baz':'1', 'bar':'2'}
foo/abc/def    -&gt; Params {'baz':'abc', 'bar':'def'}
</code></pre></div><p>但是，它与以下模式不匹配：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/1/2/        -&gt; No match (trailing slash)
bar/abc/def     -&gt; First segment literal mismatch
</code></pre></div><p>段中段替换标记的匹配将只完成到模式中段中的第一个非字母数字字符。因此，例如，如果使用此路由模式：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/{name}.html
</code></pre></div><p>字面路径<code>/foo/biz.html</code>将匹配上述路由模式，匹配结果将是<code>Params{'name'：'biz'}</code>。但是，字面路径 <code>/foo/biz</code>将不匹配，因为它在由<code>{name}.html</code>表示的段末尾不包含字面 <code>.html</code>（它只包含<code>biz</code>，而不包含<code>biz.html</code>).</p> <p>要捕获这两个片段，可以使用两个替换标记：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/{name}.html
</code></pre></div><p>字面路径<code>/foo/biz.html</code>将匹配上述路由模式，匹配结果将是<code>Params{'name'：'biz'，'ext'：'html'}</code>。发生这种情况是因为有一个文字部分。（句点）在两个替换标记<code>{name}</code>和<code>{ext}</code>之间。</p> <p>替换标记可以选择指定一个正则表达式，该正则表达式将用于确定路径段是否应与标记匹配。若要指定替换标记应仅匹配由正则表达式定义的特定字符集，必须使用稍微扩展的替换标记语法形式。
在大括号中，替换标记名后面必须跟一个冒号，然后紧接着是正则表达式。与替换标记<code>[^/]+</code>关联的默认正则表达式匹配一个或多个不是斜线的字符。例如，在hood下，替换标记<code>{foo}</code>可以更详细地拼写为<code>{foo:[^/]+}</code>。
你可以将其更改为任意正则表达式以匹配任意字符序列，例如<code>{foo:\d+}</code>以仅匹配数字。</p> <p>段必须至少包含一个字符才能匹配段替换标记。例如，对于URL<code>/abc/</code>：</p> <ul><li><code>/abc/{foo}</code> 不匹配。</li> <li><code>/{foo}</code> 匹配。</li></ul> <div class="tip custom-block"><p class="title">Note:</p><p>在匹配模式之前，路径将不带引号并解码为有效的unicode字符串，表示匹配路径段的值也将不带引号。</p></div><p>例如，以下模式：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/{bar}
</code></pre></div><p>当匹配以下URL时：</p> <div class="language-text extra-class"><pre class="language-text"><code>http://example.com/foo/La%20Pe%C3%B1a
</code></pre></div><p>匹配字典将如下所示（值是URL-decoded）：</p> <div class="language-text extra-class"><pre class="language-text"><code>Params{'bar': 'La Pe\xf1a'}
</code></pre></div><p>路径段中的文本字符串应表示提供给actix的路径的解码值。你不想在模式中使用<code>URL-encoded</code>的值。例如，而不是这样：</p> <div class="language-text extra-class"><pre class="language-text"><code>/Foo%20Bar/{baz}
</code></pre></div><p>你会想用这样的东西：</p> <div class="language-text extra-class"><pre class="language-text"><code>/Foo Bar/{baz}
</code></pre></div><p>有可能得到“<code>尾匹配</code>”。为此，必须使用自定义正则。</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/{bar}/{tail:.*}
</code></pre></div><p>上述模式将匹配这些url，并生成以下匹配信息：</p> <div class="language-text extra-class"><pre class="language-text"><code>foo/1/2/           -&gt; Params{'bar':'1', 'tail': '2/'}
foo/abc/def/a/b/c  -&gt; Params{'bar':u'abc', 'tail': 'def/a/b/c'}
</code></pre></div><h4 id="routes范围"><a href="#routes范围" class="header-anchor">#</a> Routes范围</h4> <p>作用域帮助你组织共享公用根路径的路由。可以在作用域内嵌套作用域。</p> <p>假设你想要组织指向用于查看“用户”的端点的路径。这些路径可以包括：</p> <ul><li><code>/users</code></li> <li><code>/users/show</code></li> <li><code>/users/show/{id}</code></li></ul> <p>这些路径的作用域布局如下所示</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">show_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Show users&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">user_detail</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;User detail: {}&quot;</span><span class="token punctuation">,</span> path<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/show&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>show_users<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/show/{id}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>user_detail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>局部路径可以包含变量路径段作为资源。与非工作路径一致。</p> <p>你可以从<code>HttpRequest::match_info()</code>获取变量路径段。路径提取器还可以提取范围级别的变量段。</p> <h4 id="匹配信息"><a href="#匹配信息" class="header-anchor">#</a> 匹配信息</h4> <p>所有表示匹配路径段的值都可以在<code>HttpRequest::match_info</code>中找到。可以使用<code>Path::get()</code>检索特定值。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v1<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> v2<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;v2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Values {} {} {} {}&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/a/{v1}/{v2}/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于路径“<code>/a/1/2/</code>”的本例，值v1和v2将解析为“<code>1</code>”和“<code>2</code>”。</p> <p>可以从尾部路径参数创建<code>PathBuf</code>。返回的<code>PathBuf</code>已解码百分比。如果段等于“..”，则跳过上一段（如果有）</p> <p>为安全起见，如果某个段满足以下任何条件，则返回一个<code>Err</code>，指示满足的条件：</p> <ul><li>解码以下任一项开头：<code>.</code>(除了 <code>..</code>),<code>*</code></li> <li>解码以下任一项结尾：<code>:</code>,<code>&gt;</code>,<code>&lt;</code></li> <li>解码包含以下一项：<code>/</code></li> <li>在Windows上，解码段包含:‘'</li> <li>百分比编码导致无效的UTF8。</li></ul> <p>由于这些条件，从请求路径参数解析的<code>PathBuf</code>可以安全地插入或用作路径的后缀，而无需额外检查。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;tail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Path {:?}&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">r&quot;/a/{tail:.*}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="路径信息抽取器"><a href="#路径信息抽取器" class="header-anchor">#</a> 路径信息抽取器</h4> <p>Actix提供类型安全路径信息提取功能。<a href="https://docs.rs/actix-web/2/actix_web/dev/struct.Path.html" target="_blank" rel="noopener noreferrer"><code>路径</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提取信息，目的地类型可以定义为几种不同的形式。最简单的方法是使用<code>tuple</code>类型。
元组中的每个元素必须对应于路径模式中的一个元素。比如：可以将路径模式<code>/{id}/{username}/</code>与<code>Path&lt;(u32，String)&gt;</code>类型匹配，但<code>路径&lt;(String,String,String)&gt;</code>类型将始终失败。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span><span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token namespace">info<span class="token punctuation">::</span>web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {} ！ id:{}&quot;</span><span class="token punctuation">,</span>info<span class="token number">.0</span><span class="token punctuation">,</span>info<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span><span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/{username}/{id}/index.html&quot;</span><span class="token punctuation">,</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8085&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还可以将路径模式信息提取到结构,在这种情况下，此结构必须实现<em>serde的</em><code>反序列化</code>特性。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// extract path info using serde</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/{username}/index.html&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- define path parameters</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://docs.rs/actix-web/2/actix_web/web/struct.Query.html" target="_blank" rel="noopener noreferrer">查询<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>为请求查询参数提供类似的功能。</p> <h4 id="生成资源url"><a href="#生成资源url" class="header-anchor">#</a> 生成资源URL</h4> <p>使用的<a href="https://docs.rs/actix-web/2/actix_web/struct.HttpRequest.html#method.url_for" target="_blank" rel="noopener noreferrer"><em>HttpRequest.url()</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 根据资源模式生成URL的方法。例如，如果你配置了名为“<code>foo</code>”且模式为“<code>{a}/{b}/{c}</code>”的资源，则可以执行以下操作：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>guard<span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span>header<span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">url_for</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- 为&quot;foo&quot;资源生成url</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Found</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token namespace">header<span class="token punctuation">::</span></span><span class="token constant">LOCATION</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/test/{a}/{b}/{c}&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token comment">// &lt;- set resource name, then it could be used in `url_for`</span>
                    <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/test/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这将返回类似字符串的内容<code>http://example.com/test/1/2/3</code>（至少在当前协议和主机名暗示<code>http://example.com</code>网站). 方法返回url对象，以便你可以修改此url（添加查询参数、锚等）。只能为命名资源调用<code>url_for()</code>，否则返回错误。</p> <h4 id="外部资源"><a href="#外部资源" class="header-anchor">#</a> 外部资源</h4> <p>资源是有效的url，可以注册为外部资源。它们只用于URL生成，从不考虑在请求时进行匹配。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">url_for</span><span class="token punctuation">(</span><span class="token string">&quot;youtube&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">&quot;oHg5SJYRHA0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;https://youtube.com/watch/oHg5SJYRHA0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    url<span class="token punctuation">.</span><span class="token function">into_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">external_resource</span><span class="token punctuation">(</span><span class="token string">&quot;youtube&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://youtube.com/watch/{video_id}&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">actix_web<span class="token punctuation">::</span>web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="路径规范化和重定向到斜线附加路由"><a href="#路径规范化和重定向到斜线附加路由" class="header-anchor">#</a> 路径规范化和重定向到斜线附加路由</h4> <p>规范化意味着：</p> <ul><li>在路径中添加尾随斜杠。</li> <li>将多个斜线替换为一个斜线。</li></ul> <p>处理程序在找到正确解析的路径后立即返回。如果启用了所有规范化条件，则规范化条件的顺序为<code>1)merge</code>、<code>2)merge</code>和append以及<code>3)append</code>。如果路径至少使用其中一个条件解析，它将重定向到新路径。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>middleware<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">NormalizePath</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/resource/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在本例中，<code>//resource///</code>将被重定向到<code>/resource/</code>。</p> <p>在本例中，为所有方法注册了路径规范化处理程序，但不应依赖此机制来重定向<code>POST</code>请求。<code>NOT FOUND</code>斜杠追加的重定向会将<code>POST</code>请求转换为<code>GET</code>，从而丢失原始请求中的任何<code>POST</code>数据。</p> <p>只能为<code>GET</code>请求注册路径规范化：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Method</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">NormalizePath</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/resource/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">default_service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用应用程序前缀组合应用程序"><a href="#使用应用程序前缀组合应用程序" class="header-anchor">#</a> 使用应用程序前缀组合应用程序</h4> <p><code>web::scope()</code>方法允许设置特定的应用程序范围。此作用域表示一个资源前缀，该前缀将作为资源配置添加的所有资源模式的前缀。这可用于帮助在不同的位置装入一组路由，而不是包含的可调用文件的作者想要的位置，同时仍然保持相同的资源名称。</p> <p>例如：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">show_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;Show users&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">user_detail</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;User detail: {}&quot;</span><span class="token punctuation">,</span> path<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/show&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>show_users<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/show/{id}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>user_detail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的示例中，<code>show_users</code>路由将有一个有效的路由模式<code>/users/show</code>而不是<code>/show</code>，因为应用程序的作用域将在该模式之前。只有当URL路径是<code>/users/show</code>，并且<code>HttpRequest.url_for()</code>函数是用路由名<code>show_users</code>调用的，它将生成具有相同路径的URL。</p> <h4 id="自定义线路守卫"><a href="#自定义线路守卫" class="header-anchor">#</a> 自定义线路守卫</h4> <p>你可以将保护程序看作一个简单的函数，它接受请求对象引用并返回<code>true</code>或<code>false</code>。在形式上，<a href="https://docs.rs/actix-web/2/actix_web/guard/trait.Guard.html" target="_blank" rel="noopener noreferrer">守卫<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是实现守卫特性的任何对象。Actix提供了几个谓词，可以检查api文档的函数部分。</p> <p>下面是一个简单的保护程序，用于检查请求是否包含特定的头：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">RequestHead</span><span class="token punctuation">,</span> <span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Guard</span><span class="token punctuation">,</span> http<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">ContentTypeHeader</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Guard</span> <span class="token keyword">for</span> <span class="token class-name">ContentTypeHeader</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">RequestHead</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span><span class="token namespace">http<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token class-name">ContentTypeHeader</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在本例中，只有当请求包含<code>Content-Type</code>头时，才会调用索引处理程序。</p> <p>守卫无法访问或修改请求对象，但可以在<a href="https://docs.rs/actix-web/2/actix_web/struct.HttpRequest.html#method.extensions" target="_blank" rel="noopener noreferrer">请求扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中存储额外信息。</p> <h4 id="修改守卫值"><a href="#修改守卫值" class="header-anchor">#</a> 修改守卫值</h4> <p>通过将任何谓词值包装在Not谓词中，可以反转其含义。例如，如果要为除“GET”之外的所有方法返回“METHOD NOT ALLOWED”响应：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>guard<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Not</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>任何</code>守卫接受守卫和匹配的列表，如果任何提供的守卫匹配。即：</p> <div class="language-text extra-class"><pre class="language-text"><code>guard::Any(guard::Get()).or(guard::Post())
</code></pre></div><p>如果所有提供的守卫都匹配，则全守卫接受守卫和火柴的列表。即：</p> <div class="language-text extra-class"><pre class="language-text"><code>guard::All(guard::Get()).and(guard::Header(&quot;content-type&quot;, &quot;plain/text&quot;))
</code></pre></div><h4 id="更改默认未找到响应"><a href="#更改默认未找到响应" class="header-anchor">#</a> 更改默认未找到响应</h4> <p>如果在路由表中找不到路径模式或资源找不到匹配的路由，则使用默认资源。找不到默认响应。可以使用<code>App::default_service()</code>覆盖<code>NOT FOUND</code>的响应。此方法接受与<code>App::service()</code>方法的正常资源配置相同的配置函数。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">default_service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Not</span><span class="token punctuation">(</span><span class="token namespace">guard<span class="token punctuation">::</span></span><span class="token class-name">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="requests-请求"><a href="#requests-请求" class="header-anchor">#</a> Requests 请求</h3> <h4 id="内容编码"><a href="#内容编码" class="header-anchor">#</a> 内容编码</h4> <p><code>Actix-web</code>自动解<code>压缩</code>有效负载，支持以下编解码器：</p> <ul><li>Brotli</li> <li>Chunked</li> <li>Compress</li> <li>Gzip</li> <li>Deflate</li> <li>Identity</li> <li>Trailers</li> <li>EncodingExt</li></ul> <p>如果请求头包含<code>Content-Encoding</code>头，则根据头值对请求负载进行解压缩。不支持多个编解码器，即：<code>Content-Encoding</code>：<code>br</code>，<code>gzip</code>。</p> <h4 id="json-request"><a href="#json-request" class="header-anchor">#</a> JSON Request</h4> <p>json主体反序列化有几个选项。</p> <p>第一个选项是使用Json提取器。首先，定义一个接受<code>Json&lt;T&gt;</code>作为参数的处理函数，然后使用<code>.to()</code>方法注册这个处理程序。还可以通过使用<code>serde_json::Value</code>作为类型<code>T</code>来接受任意有效的json对象。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Info</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// extract `Info` using serde</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>info<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Json</span><span class="token operator">&lt;</span><span class="token class-name">Info</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome {}!&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你还可以手动将负载加载到内存中，然后对其进行反序列化。</p> <p>在下面的示例中，我们将反序列化<code>MyObj</code>结构。我们需要先加载请求体，然后将json反序列化为一个对象。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>error<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">bytes<span class="token punctuation">::</span></span><span class="token class-name">BytesMut</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span></span><span class="token class-name">StreamExt</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> serde_json<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Serialize, Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyObj</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">MAX_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">262_144</span><span class="token punctuation">;</span> <span class="token comment">// max payload size is 256k</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index_manual</span><span class="token punctuation">(</span><span class="token keyword">mut</span> payload<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Payload</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// payload is a stream of Bytes objects</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> body <span class="token operator">=</span> <span class="token class-name">BytesMut</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> chunk <span class="token operator">=</span> chunk<span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token comment">// limit max size of in-memory payload</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> chunk<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_SIZE</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ErrorBadRequest</span><span class="token punctuation">(</span><span class="token string">&quot;overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        body<span class="token punctuation">.</span><span class="token function">extend_from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// body is loaded, now we can deserialize serde-json</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_slice</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">MyObj</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &lt;- send response</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例目录中提供了这两个选项的<a href="https://github.com/actix/examples/tree/master/json/" target="_blank" rel="noopener noreferrer">完整示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="分块传输编码"><a href="#分块传输编码" class="header-anchor">#</a> 分块传输编码</h4> <p>Actix自动解码分块编码。<code>web::Payload</code>提取程序已包含解码字节流。如果使用支持的压缩编解码器（<code>br</code>、<code>gzip</code>、<code>deflate</code>）之一压缩请求负载，则解压缩字节流。</p> <h4 id="多部分body"><a href="#多部分body" class="header-anchor">#</a> 多部分body</h4> <p>Actix-web通过一个外部机箱<a href="https://crates.io/crates/actix-multipart" target="_blank" rel="noopener noreferrer">Actix multipart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>提供多部分流支持。</p> <p>示例目录中提供了<a href="https://github.com/actix/examples/tree/master/multipart/" target="_blank" rel="noopener noreferrer">完整的示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="urlencoded-body"><a href="#urlencoded-body" class="header-anchor">#</a> Urlencoded body</h4> <p><code>Actix-web</code>使用<code>web::form</code>提取器为<code>application/x-www-form-urlencoded</code>编码的实体提供支持，该提取器解析为反序列化实例。实例的类型必须实现serde的反序列化特性。</p> <p><code>UrlEncoded</code> future可以在以下几种情况下解决错误：</p> <ul><li>content-type 不是 application/x-www-form-urlencoded</li> <li>传输编码是<code>chunked</code></li> <li>内容长度大于256k</li> <li>有效负载因错误而终止。</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FormData</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>form<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Form</span><span class="token operator">&lt;</span><span class="token class-name">FormData</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;username: {}&quot;</span><span class="token punctuation">,</span> form<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="streaming-请求"><a href="#streaming-请求" class="header-anchor">#</a> Streaming 请求</h4> <p><code>HttpRequest</code>是<code>Bytes</code>对象流。它可用于读取请求正文负载。</p> <p>在下面的示例中，我们逐块读取和打印请求负载：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span></span><span class="token class-name">StreamExt</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token keyword">mut</span> body<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Payload</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> bytes <span class="token operator">=</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">BytesMut</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> item <span class="token operator">=</span> item<span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Chunk: {:?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bytes<span class="token punctuation">.</span><span class="token function">extend_from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="responses-响应"><a href="#responses-响应" class="header-anchor">#</a> Responses(响应)</h3> <p>类生成器模式用于构造<code>HttpResponse</code>的实例, <code>HttpResponse</code>提供了几个返回<code>HttpResponseBuilder</code>实例的方法，这些方法实现了各种方便的方法来生成响应。</p> <p>检查<a href="https://docs.rs/actix-web/2/actix_web/dev/struct.HttpResponseBuilder.html" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的类型说明。</p> <p>方法<code>.body</code>、<code>.finish</code>和<code>.json</code>完成响应创建并返回构造的<code>HttpResponse</code>实例，如果在同一个生成器实例上多次调用此方法，则生成器将死机。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token class-name">HttpResponse</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">content_type</span><span class="token punctuation">(</span><span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;X-Hdr&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;sample&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="内容编码-2"><a href="#内容编码-2" class="header-anchor">#</a> 内容编码</h4> <p><code>Actix-web</code>可以使用<a href="https://docs.rs/actix-web/2/actix_web/middleware/struct.Compress.html" target="_blank" rel="noopener noreferrer">压缩中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>自动压缩有效负载,支持以下编解码器：</p> <ul><li>Brotli</li> <li>Gzip</li> <li>Deflate</li> <li>Identity</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>middleware<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index_br</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Compress</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index_br<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>响应负载根据<code>middleware::BodyEncoding</code> trait中的编码参数进行压缩。默认情况下，使用<code>ContentEncoding::Auto</code>。如果选择<code>ContentEncoding::Auto</code>，则压缩取决于请求的<code>Accept-Encoding</code>头。</p> <p><code>ContentEncoding::Identity</code>可用于禁用压缩。如果选择了另一个内容编码，则对该编解码器强制执行压缩。</p> <p>例如，要为单个处理程序启用<code>brotli</code>，请使用<code>ContentEncoding::Br</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">BodyEncoding</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index_br</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">encoding</span><span class="token punctuation">(</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Br</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>middleware<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Compress</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index_br<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者对于整个应用程序：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">BodyEncoding</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index_br</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>middleware<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Compress</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Br</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index_br<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这种情况下，我们通过将内容编码设置为<code>Identity</code>值显式禁用内容压缩：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">BodyEncoding</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// v- disable compression</span>
        <span class="token punctuation">.</span><span class="token function">encoding</span><span class="token punctuation">(</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Identity</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Compress</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>处理已压缩的正文时（例如，在为资产提供服务时），请将<code>Content-Type</code>设置为<code>Identity</code>以避免压缩已压缩的数据，并手动设置内容编码头：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">BodyEncoding</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token constant">HELLO_WORLD</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
    <span class="token number">0x1f</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xa2</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x5c</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0xcb</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xcd</span><span class="token punctuation">,</span> <span class="token number">0xc9</span><span class="token punctuation">,</span>
    <span class="token number">0xc9</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xcf</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xca</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0xe1</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0xaf</span><span class="token punctuation">,</span>
    <span class="token number">0x0c</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">encoding</span><span class="token punctuation">(</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Identity</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;content-encoding&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token constant">HELLO_WORLD</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此外，还可以在应用程序级别设置默认内容编码，默认情况下使用<code>ContentEncoding::Auto</code>，这意味着自动内容压缩协商。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">Compress</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Br</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="json-response"><a href="#json-response" class="header-anchor">#</a> JSON Response</h4> <p>Json类型允许使用格式良好的Json数据进行响应：只需返回<code>Json&lt;T&gt;</code>类型的值，其中T是要序列化为<code>JSON</code>的结构类型。类型<code>T</code>必须实现serde的<code>序列化</code>特性。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Serialize, Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyObj</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token class-name">MyObj</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token class-name">MyObj</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">r&quot;/a/{name}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="testing-测试"><a href="#testing-测试" class="header-anchor">#</a> Testing(测试)</h3> <p>每个应用程序都应该经过良好的测试。<code>Actix-web</code>提供了执行单元和集成测试的工具。</p> <p>对于单元测试，<code>actix-web</code>提供了一个请求生成器类型。<code>TestRequest</code>实现了一个类似于builder的模式。你可以使用<code>to_http_request()</code>生成一个<code>HttpRequest</code>实例，并用它调用处理程序。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span>test<span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_index_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">with_header</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_http_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_index_not_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_http_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="集成测试"><a href="#集成测试" class="header-anchor">#</a> 集成测试</h4> <p>有几种测试应用程序的方法。<code>Actix-web</code>可用于在真正的http服务器中使用特定的处理程序运行应用程序。</p> <p><code>TestRequest::get()</code>、<code>TestRequest::post()</code>和其他方法可用于向测试服务器发送请求。</p> <p>要创建用于测试的服务，请使用接受常规<code>App</code>生成器的<code>test::init_service</code>方法。</p> <p>查看<a href="https://docs.rs/actix-web/2/actix_web/test/index.html" target="_blank" rel="noopener noreferrer">api文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以获取更多信息。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>test<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_index_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> app <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">init_service</span><span class="token punctuation">(</span><span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">with_header</span><span class="token punctuation">(</span><span class="token string">&quot;content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">call_service</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> app<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_index_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> app <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">init_service</span><span class="token punctuation">(</span><span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">call_service</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> app<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_client_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你需要更复杂的应用程序，那么测试应该与创建普通应用程序非常相似。例如，你可能需要初始化应用程序状态。使用<code>data</code>方法创建<code>App</code>并附加状态，就像从普通应用程序中一样。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>test<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_index_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> app <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">init_service</span><span class="token punctuation">(</span>
            <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token class-name">AppState</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp<span class="token punctuation">:</span> <span class="token class-name">AppState</span> <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">read_response_json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> app<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="流响应测试"><a href="#流响应测试" class="header-anchor">#</a> 流响应测试</h4> <p>如果你需要测试流，那么只需调用<code>take_body()</code>并将结果<code>ResponseBody</code>转换为future并执行它就足够了，例如测试<code>Server Send Events</code>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token class-name">Poll</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">bytes<span class="token punctuation">::</span></span><span class="token class-name">Bytes</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>stream<span class="token punctuation">::</span></span>poll_fn<span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span>http<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">ContentEncoding</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> http<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">sse</span><span class="token punctuation">(</span>_req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HttpResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">// yields `data: N` where N in [5; 1]</span>
    <span class="token keyword">let</span> server_events <span class="token operator">=</span> <span class="token function">poll_fn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_cx<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Bytes</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;data: {}\n\n&quot;</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">OK</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set_header</span><span class="token punctuation">(</span><span class="token namespace">http<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span> <span class="token string">&quot;text/event-stream&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set_header</span><span class="token punctuation">(</span>
            <span class="token namespace">http<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_ENCODING</span><span class="token punctuation">,</span>
            <span class="token class-name">ContentEncoding</span><span class="token punctuation">::</span><span class="token class-name">Identity</span><span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">streaming</span><span class="token punctuation">(</span>server_events<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>sse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> actix_rt<span class="token punctuation">;</span>

    <span class="token keyword">use</span> <span class="token namespace">futures_util<span class="token punctuation">::</span>stream<span class="token punctuation">::</span></span><span class="token class-name">StreamExt</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">futures_util<span class="token punctuation">::</span>stream<span class="token punctuation">::</span></span><span class="token class-name">TryStreamExt</span><span class="token punctuation">;</span>

    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>test<span class="token punctuation">,</span> web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[actix_rt::test]</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">test_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> app <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">init_service</span><span class="token punctuation">(</span><span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>sse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token class-name">TestRequest</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> resp <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">call_service</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> app<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// first chunk</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token keyword">mut</span> resp<span class="token punctuation">)</span> <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">take_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">b&quot;data: 5\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// second chunk</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token keyword">mut</span> resp<span class="token punctuation">)</span> <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">take_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">b&quot;data: 4\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// remaining part</span>
        <span class="token keyword">let</span> bytes <span class="token operator">=</span> <span class="token namespace">test<span class="token punctuation">::</span></span><span class="token function">load_stream</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">take_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bytes</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">b&quot;data: 3\n\ndata: 2\n\ndata: 1\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="middleware-中间器件"><a href="#middleware-中间器件" class="header-anchor">#</a> Middleware 中间器件</h3> <p><code>Actix-web</code>的中间件系统允许我们为请求/响应处理添加额外的行为。中间件可以钩住一个传入的请求进程，使我们能够修改请求，并停止请求处理以提前返回响应。</p> <p>中间件还可以连接到响应处理中。</p> <p>通常，中间件涉及以下操作：</p> <ul><li>预处理请求</li> <li>后处理一个响应</li> <li>修改应用程序状态</li> <li>访问外部服务（<code>redis</code>、日志记录、<code>sessions</code>）</li></ul> <p>中间件为每个<code>App</code>、<code>scope</code>或<code>Resource</code>注册，并按注册的相反顺序执行。一般来说，中间件是一种实现<code>服务特性</code>和<code>转换特性</code>的类型。traits中的每个方法都有一个默认实现，每个方法都可以立即返回结果或将来的对象。</p> <p>下面演示如何创建一个简单的中间件：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Poll</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">actix_service<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Service</span><span class="token punctuation">,</span> <span class="token class-name">Transform</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">ServiceRequest</span><span class="token punctuation">,</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">ServiceResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>future<span class="token punctuation">::</span></span><span class="token punctuation">{</span>ok<span class="token punctuation">,</span> <span class="token class-name">Ready</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span></span><span class="token class-name">Future</span><span class="token punctuation">;</span>

<span class="token comment">// There are two steps in middleware processing.</span>
<span class="token comment">// 1. Middleware initialization, middleware factory gets called with</span>
<span class="token comment">//    next service in chain as parameter.</span>
<span class="token comment">// 2. Middleware's call method gets called with normal request.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SayHi</span><span class="token punctuation">;</span>

<span class="token comment">// Middleware factory is `Transform` trait from actix-service crate</span>
<span class="token comment">// `S` - type of the next service</span>
<span class="token comment">// `B` - type of response's body</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token class-name">Transform</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SayHi</span>
<span class="token keyword">where</span>
    <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">Request</span> <span class="token operator">=</span> <span class="token class-name">ServiceRequest</span><span class="token punctuation">,</span> <span class="token class-name">Response</span> <span class="token operator">=</span> <span class="token class-name">ServiceResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Future</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Request</span> <span class="token operator">=</span> <span class="token class-name">ServiceRequest</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Response</span> <span class="token operator">=</span> <span class="token class-name">ServiceResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">InitError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Transform</span> <span class="token operator">=</span> <span class="token class-name">SayHiMiddleware</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Future</span> <span class="token operator">=</span> <span class="token class-name">Ready</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Transform</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">InitError</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">new_transform</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> service<span class="token punctuation">:</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Future</span> <span class="token punctuation">{</span>
        <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">SayHiMiddleware</span> <span class="token punctuation">{</span> service <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SayHiMiddleware</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    service<span class="token punctuation">:</span> <span class="token class-name">S</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span> <span class="token keyword">for</span> <span class="token class-name">SayHiMiddleware</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">Request</span> <span class="token operator">=</span> <span class="token class-name">ServiceRequest</span><span class="token punctuation">,</span> <span class="token class-name">Response</span> <span class="token operator">=</span> <span class="token class-name">ServiceResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token class-name">S</span><span class="token punctuation">::</span><span class="token class-name">Future</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Request</span> <span class="token operator">=</span> <span class="token class-name">ServiceRequest</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Response</span> <span class="token operator">=</span> <span class="token class-name">ServiceResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Future</span> <span class="token operator">=</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Response</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">poll_ready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">poll_ready</span><span class="token punctuation">(</span>cx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token class-name">ServiceRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Future</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hi from start. You requested: {}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> fut <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> fut<span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hi from response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者，对于简单的用例，可以使用<code>wrap_fn</code>创建小型的、特别的中间产品：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_service<span class="token punctuation">::</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>future<span class="token punctuation">::</span></span><span class="token class-name">FutureExt</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">wrap_fn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>req<span class="token punctuation">,</span> srv<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hi from start. You requested: {}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            srv<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>res<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hi from response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">,</span>
            <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;Hello, middleware!&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Actix-web</code>提供了一些有用的中间件，如日志、用户会话、压缩等。</p> <h4 id="记录日志"><a href="#记录日志" class="header-anchor">#</a> 记录日志</h4> <p>日志记录是作为一个中间件实现的。通常将日志中间件注册为应用程序的第一个中间件。必须为每个应用程序注册日志中间件。</p> <p><code>Logger</code>中间件使用标准的日志箱记录信息。你应该为actix_web包启用logger以查看访问日志（<code>env_logger</code>或类似）。</p> <h4 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h4> <p>使用指定的<code>格式</code>创建<code>Logger</code>中间件。默认<code>Logger</code>可以使用<code>默认</code>方法创建，它使用默认格式：</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token operator">%</span>a <span class="token operator">%</span>t <span class="token string">&quot;%r&quot;</span> <span class="token operator">%</span>s <span class="token operator">%</span>b <span class="token string">&quot;%{Referer}i&quot;</span> <span class="token string">&quot;%{User-Agent}i&quot;</span> <span class="token operator">%</span><span class="token class-name">T</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span>middleware<span class="token punctuation">::</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">env_logger<span class="token punctuation">::</span></span><span class="token class-name">Env</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token namespace">env_logger<span class="token punctuation">::</span></span><span class="token function">from_env</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default_filter_or</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Logger</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Logger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;%a %{User-Agent}i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以下是默认日志记录格式的示例：</p> <div class="language-text extra-class"><pre class="language-text"><code>INFO:actix_web::middleware::logger: 127.0.0.1:59934 [02/Dec/2017:00:21:43 -0800] &quot;GET / HTTP/1.1&quot; 302 0 &quot;-&quot; &quot;curl/7.54.0&quot; 0.000397
INFO:actix_web::middleware::logger: 127.0.0.1:59947 [02/Dec/2017:00:22:40 -0800] &quot;GET /index.html HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:57.0) Gecko/20100101 Firefox/57.0&quot; 0.000646
</code></pre></div><h4 id="format-格式化"><a href="#format-格式化" class="header-anchor">#</a> Format(格式化)</h4> <ul><li><code>%%</code> 百分号</li> <li><code>%a</code> 远程IP地址 (如果使用反向代理，则代理的IP地址)</li> <li><code>%t</code> 开始处理请求的时间</li> <li><code>%P</code> 为请求提供服务的子进程ID</li> <li><code>%r</code> 第一行请求</li> <li><code>%s</code> 响应状态代码</li> <li><code>%b</code> 响应大小（字节），包括HTTP头</li> <li><code>%T</code> 为请求提供服务所需的时间，以秒为单位，浮动小数为.06f格式</li> <li><code>%D</code> 服务请求所用的时间（毫秒）</li> <li><code>%{FOO}i</code> request.headers[‘FOO’]</li> <li><code>%{FOO}o</code> response.headers[‘FOO’]</li> <li><code>%{FOO}e</code> os.environ[‘FOO’]</li></ul> <h4 id="默认headers"><a href="#默认headers" class="header-anchor">#</a> 默认Headers</h4> <p>要设置默认响应头，可以使用<code>DefaultHeaders</code>中间件。如果响应头已包含指定的头，则<code>DefaultHeaders</code>中间件不设置头。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>http<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token class-name">DefaultHeaders</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;X-Version&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
                        <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token constant">HEAD</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="用户sessions"><a href="#用户sessions" class="header-anchor">#</a> 用户sessions</h4> <p><code>Actix-web</code>为会话管理提供了一个通用的解决方案。<code>actix-session</code>中间件可以与不同的后端类型一起使用，在不同的后端存储会话数据。</p> <p>默认情况下，仅实现cookie会话后端。可以添加其他后端实现。</p> <p><code>CookieSession</code>使用cookies作为会话存储。<code>CookieSessionBackend</code>创建的会话限制为存储少于4000字节的数据，因为负载必须适合单个<code>cookie</code>。如果会话包含超过4000字节，则会生成内部服务器错误。</p> <p>cookie的安全策略可以是签名的或私有的。每个都有各自的<code>CookieSession</code>构造函数。</p> <p>客户端可以查看签名的cookie，但不能对其进行修改。客户端既不能查看也不能修改私有cookie。</p> <p>构造函数以键作为参数。这是cookie会话的私钥-更改此值时，所有会话数据都将丢失。</p> <p>通常，你创建一个<code>SessionStorage</code>中间件，并使用特定的后端实现（例如<code>CookieSession</code>）对其进行初始化。要访问会话数据，必须使用<code>Session</code>提取器。此方法返回一个<code>session</code>对象，该对象允许我们获取或设置会话数据。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_session<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">CookieSession</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> <span class="token class-name">Session</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// access session data</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Count is {:?}!&quot;</span><span class="token punctuation">,</span>
        session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
                <span class="token class-name">CookieSession</span><span class="token punctuation">::</span><span class="token function">signed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// &lt;- create cookie based session middleware</span>
                    <span class="token punctuation">.</span><span class="token function">secure</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h4> <p><code>ErrorHandlers</code>中间件允许我们为响应提供自定义处理程序。</p> <p>可以使用<code>ErrorHandlers::handler()</code>方法为特定状态代码注册自定义错误处理程序。你可以修改现有的响应或创建完全新的响应。错误处理程序可以立即返回响应，也可以返回解析为响应的未来。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span>middleware<span class="token punctuation">::</span>errhandlers<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">ErrorHandlerResponse</span><span class="token punctuation">,</span> <span class="token class-name">ErrorHandlers</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>dev<span class="token punctuation">,</span> http<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">render_500</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">mut</span> res<span class="token punctuation">:</span> <span class="token namespace">dev<span class="token punctuation">::</span></span><span class="token class-name">ServiceResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">ErrorHandlerResponse</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">response_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">headers_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
        <span class="token namespace">http<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span>
        <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">HeaderValue</span><span class="token punctuation">::</span><span class="token function">from_static</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ErrorHandlerResponse</span><span class="token punctuation">::</span><span class="token class-name">Response</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
                <span class="token class-name">ErrorHandlers</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span> render_500<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
                <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">MethodNotAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="static-files-静态文件"><a href="#static-files-静态文件" class="header-anchor">#</a> Static Files 静态文件</h3> <h4 id="单个文件"><a href="#单个文件" class="header-anchor">#</a> 单个文件</h4> <p>可以使用自定义路径模式和<code>NamedFile</code>为静态文件提供服务。要匹配路径尾部，可以使用<code>[.*]</code>正则表达式。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_files<span class="token punctuation">::</span></span><span class="token class-name">NamedFile</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">NamedFile</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">NamedFile</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/{filename:.*}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h4> <p>要提供来自特定目录和子目录的文件，可以使用<code>Files</code>。<code>Files</code>必须使用<code>App::service()</code>方法注册，否则将无法为子路径提供服务。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> actix_files <span class="token keyword">as</span> fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">Files</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;/static&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show_files_listing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>默认情况下，子目录的文件列表被禁用。尝试加载目录列表将返回404 Not Found响应。要启用文件列表，请使用<a href="https://docs.rs/actix-files/0.2/actix_files/struct.Files.html#method.index_file" target="_blank" rel="noopener noreferrer">files::show_files_listing()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法。</p> <h4 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h4> <p><code>NemeFiles</code> 可以指定提供文件的各种选项：</p> <ul><li><code>set_content_disposition</code> - 用于将文件的mime映射到相应内容处理类型的函数</li> <li><code>use-etag</code>                - 指定是否计算ETag并将其包含在标题中。</li> <li><code>use_last_modified</code>       - 指定是否应使用文件修改的时间戳并将其添加到<code>Last-Modified</code>的头中。</li></ul> <p>以上所有方法都是可选的，并提供了最佳的默认值，但是可以自定义其中任何一个方法。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> actix_files <span class="token keyword">as</span> fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span>http<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">ContentDisposition</span><span class="token punctuation">,</span> <span class="token class-name">DispositionType</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">NamedFile</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">NamedFile</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>file
        <span class="token punctuation">.</span><span class="token function">use_last_modified</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set_content_disposition</span><span class="token punctuation">(</span><span class="token class-name">ContentDisposition</span> <span class="token punctuation">{</span>
            disposition<span class="token punctuation">:</span> <span class="token class-name">DispositionType</span><span class="token punctuation">::</span><span class="token class-name">Attachment</span><span class="token punctuation">,</span>
            parameters<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/{filename:.*}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该配置还可以应用于目录服务：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> actix_files <span class="token keyword">as</span> fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>
            <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">Files</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;/static&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">show_files_listing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">use_last_modified</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="协议"><a href="#协议" class="header-anchor">#</a> 协议</h2> <h3 id="websocket"><a href="#websocket" class="header-anchor">#</a> Websocket</h3> <p><code>Actix-web</code>支持带有<code>Actix-web- actors</code> crate的WebSockets。可以将请求的<code>Payload</code>转换为带有<code>web::Payload</code>的<code>ws::Message</code>流，然后使用流组合器处理实际消息，但是使用http <code>actor</code>处理websocket通信更简单。</p> <p>下面是一个简单的<code>websocket</code> echo服务器示例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Actor</span><span class="token punctuation">,</span> <span class="token class-name">StreamHandler</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web_actors<span class="token punctuation">::</span></span>ws<span class="token punctuation">;</span>

<span class="token comment">/// Define http actor</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyWs</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">MyWs</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">WebsocketContext</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Handler for ws::Message message</span>
<span class="token keyword">impl</span> <span class="token class-name">StreamHandler</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">,</span> <span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">ProtocolError</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyWs</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">,</span> <span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">ProtocolError</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> msg <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">::</span><span class="token class-name">Ping</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">pong</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">::</span><span class="token class-name">Text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">::</span><span class="token class-name">Binary</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">binary</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> stream<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Payload</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token namespace">ws<span class="token punctuation">::</span></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">MyWs</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/ws/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://github.com/actix/examples/tree/master/websocket/" target="_blank" rel="noopener noreferrer">示例目录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中提供了一个简单的websocket echo服务器示例。</p> <p><a href="https://github.com/actix/examples/tree/master/websocket-chat/" target="_blank" rel="noopener noreferrer">websocket-chat 目录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中提供了一个能够通过websocket或tcp连接进行聊天的示例聊天服务器</p> <h3 id="http-2-0"><a href="#http-2-0" class="header-anchor">#</a> HTTP/2.0</h3> <p>如果可能，<code>actix-web</code>会自动升级到<code>HTTP/2.0</code>的连接。</p> <h4 id="谈判"><a href="#谈判" class="header-anchor">#</a> 谈判</h4> <p>未经事先了解的tls上的<em>HTTP/2.0</em>协议需要<a href="https://tools.ietf.org/html/rfc7301" target="_blank" rel="noopener noreferrer">tls alpn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>目前，只有<code>rust-openssl</code>有支持。</p> <p><code>alpn</code>协商需要启用该功能。启用时，<code>HttpServer</code>提供<code>bind_openssl</code>方法。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
actix<span class="token operator">-</span>web <span class="token operator">=</span> <span class="token punctuation">{</span> version <span class="token operator">=</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;openssl&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
actix<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span>
openssl <span class="token operator">=</span> <span class="token punctuation">{</span> version <span class="token operator">=</span> <span class="token string">&quot;0.10&quot;</span><span class="token punctuation">,</span> features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;v110&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">openssl<span class="token punctuation">::</span>ssl<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">SslAcceptor</span><span class="token punctuation">,</span> <span class="token class-name">SslFiletype</span><span class="token punctuation">,</span> <span class="token class-name">SslMethod</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>_req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Hello.&quot;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// load ssl keys</span>
    <span class="token comment">// to create a self-signed temporary cert for testing:</span>
    <span class="token comment">// `openssl req -x509 -newkey rsa:4096 -nodes -keyout key.pem -out cert.pem -days 365 -subj '/CN=localhost'`</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> builder <span class="token operator">=</span> <span class="token class-name">SslAcceptor</span><span class="token punctuation">::</span><span class="token function">mozilla_intermediate</span><span class="token punctuation">(</span><span class="token class-name">SslMethod</span><span class="token punctuation">::</span><span class="token function">tls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder
        <span class="token punctuation">.</span><span class="token function">set_private_key_file</span><span class="token punctuation">(</span><span class="token string">&quot;key.pem&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SslFiletype</span><span class="token punctuation">::</span><span class="token constant">PEM</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">set_certificate_chain_file</span><span class="token punctuation">(</span><span class="token string">&quot;cert.pem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bind_openssl</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不支持升级到rfc第3.2节中描述的<em>HTTP/2.0</em>架构。明文连接和tls连接都支持使用先前的知识启动<em>HTTP/2</em>，<a href="https://http2.github.io/http2-spec/#rfc.section.3.4" target="_blank" rel="noopener noreferrer">rfc第3.4节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>查看<a href="https://github.com/actix/examples/tree/master/rustls" target="_blank" rel="noopener noreferrer">examples/tls<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 以获取具体示例。</p> <h2 id="patterns-模式"><a href="#patterns-模式" class="header-anchor">#</a> Patterns 模式</h2> <h3 id="autoreloading-自动重载"><a href="#autoreloading-自动重载" class="header-anchor">#</a> Autoreloading 自动重载</h3> <h4 id="自动重新加载开发服务器"><a href="#自动重新加载开发服务器" class="header-anchor">#</a> 自动重新加载开发服务器</h4> <p>在开发过程中，让cargo在更改时自动重新编译代码非常方便。这可以通过使用<code>cargo-watch</code>来完成。因为actix应用程序通常会绑定到端口以侦听传入的HTTP请求，所以将其与<code>listenfd</code> crate和<code>systemfd</code>实用程序结合起来以确保在应用程序编译和重新加载时套接字保持打开是有意义的。</p> <p><code>systemfd</code>将打开一个套接字并将其传递给<code>cargo-watch</code>，后者将监视更改，然后调用编译器并运行actix应用程序。actix应用程序将使用<code>listenfd</code>来获取<code>systemfd</code>打开的套接字。</p> <h4 id="必需的二进制文件"><a href="#必需的二进制文件" class="header-anchor">#</a> 必需的二进制文件</h4> <p>要获得自动重新装载体验，你需要安装<code>cargo-watch</code>和<code>systemfd</code>。两者都是用铁锈写的，可与<code>cargo-install</code>一起安装：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>cargo <span class="token function">install</span> systemfd cargo-watch
</code></pre></div><h4 id="代码变更"><a href="#代码变更" class="header-anchor">#</a> 代码变更</h4> <p>此外，你需要稍微修改actix应用程序，以便它可以拿起<code>systemfd</code>打开的外部套接字。将listenfd依赖项添加到应用程序：</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">listenfd</span><span class="token punctuation">=</span><span class="token string">&quot;0.3&quot;</span>
</code></pre></div><p>然后修改服务器代码以仅调用<code>bind</code>作为回退：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">listenfd<span class="token punctuation">::</span></span><span class="token class-name">ListenFd</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>_req<span class="token punctuation">:</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Hello World!&quot;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> listenfd <span class="token operator">=</span> <span class="token class-name">ListenFd</span><span class="token punctuation">::</span><span class="token function">from_env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> server <span class="token operator">=</span> <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> listenfd<span class="token punctuation">.</span><span class="token function">take_tcp_listener</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:3000&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="运行服务器"><a href="#运行服务器" class="header-anchor">#</a> 运行服务器</h4> <p>要现在运行开发服务器，请调用以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>
systemfd --no-pid -s http::3000 -- cargo <span class="token function">watch</span> -x run
</code></pre></div><h3 id="databases-数据库"><a href="#databases-数据库" class="header-anchor">#</a> Databases 数据库</h3> <h4 id="diesel"><a href="#diesel" class="header-anchor">#</a> Diesel</h4> <p>目前，Diesel1.0不支持异步操作，但是可以使用<code>Actix</code> 同步Actor系统作为数据库接口api。</p> <p>从技术上讲，同步<code>Actor</code>是<code>worker</code>风格的<code>Actor</code>。多个同步参与者可以并行运行并处理来自同一队列的消息。同步<code>Actor</code>在mpsc模式下工作。</p> <p>让我们创建一个简单的数据库api，它可以将新的用户行插入到<code>SQLite</code>表中。我们必须定义一个同步参与者和这个参与者将使用的连接。同样的方法也可以用于其他数据库。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">actix<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">DbExecutor</span><span class="token punctuation">(</span><span class="token class-name">SqliteConnection</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Actor</span> <span class="token keyword">for</span> <span class="token class-name">DbExecutor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Context</span> <span class="token operator">=</span> <span class="token class-name">SyncContext</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是我们<code>Actor</code>的定义。现在，我们必须定义创建用户消息和响应。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">CreateUser</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Message</span> <span class="token keyword">for</span> <span class="token class-name">CreateUser</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以向<code>DbExecutor</code> actor发送<code>CreateUser</code>消息，结果，我们将收到一个<code>User</code>模型实例。接下来，我们必须定义此消息的处理程序实现。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Handler</span><span class="token operator">&lt;</span><span class="token class-name">CreateUser</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">DbExecutor</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Result</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token class-name">CreateUser</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Context</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token keyword">self</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>schema<span class="token punctuation">::</span>users<span class="token punctuation">::</span>dsl<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

        <span class="token comment">// Create insertion model</span>
        <span class="token keyword">let</span> uuid <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token namespace">uuid<span class="token punctuation">::</span></span><span class="token class-name">Uuid</span><span class="token punctuation">::</span><span class="token function">new_v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> new_user <span class="token operator">=</span> <span class="token namespace">models<span class="token punctuation">::</span></span><span class="token class-name">NewUser</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uuid<span class="token punctuation">,</span>
            name<span class="token punctuation">:</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// normal diesel operations</span>
        <span class="token namespace">diesel<span class="token punctuation">::</span></span><span class="token function">insert_into</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_user<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Error inserting person&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> items <span class="token operator">=</span> users
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token namespace">models<span class="token punctuation">::</span></span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Error loading person&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就这样！现在，我们可以从任何http处理程序或中间件中使用<code>DbExecutor</code> actor。我们只需要启动<code>DbExecutor</code> actors并将地址存储在http处理程序可以访问的状态中。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// This is state where we will store *DbExecutor* address.</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">:</span> <span class="token class-name">Addr</span><span class="token operator">&lt;</span><span class="token class-name">DbExecutor</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sys <span class="token operator">=</span> <span class="token namespace">actix<span class="token punctuation">::</span></span><span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;diesel-example&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start 3 parallel db executors</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">SyncArbiter</span><span class="token punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">DbExecutor</span><span class="token punctuation">(</span><span class="token class-name">SqliteConnection</span><span class="token punctuation">::</span><span class="token function">establish</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start http server</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">with_state</span><span class="token punctuation">(</span><span class="token class-name">State</span> <span class="token punctuation">{</span> db<span class="token punctuation">:</span> addr<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;/{name}&quot;</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>r<span class="token closure-punctuation punctuation">|</span></span> r<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8080&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Started http server: 127.0.0.1:8080&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们将在请求处理程序中使用该地址。句柄返回一个未来对象；因此，我们异步接收消息响应。<code>Route::a()</code>必须用于异步处理程序注册。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Async handler</span>
<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HttpRequest</span><span class="token operator">&lt;</span><span class="token class-name">State</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">Error</span> <span class="token operator">=</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token operator">&amp;</span>req<span class="token punctuation">.</span><span class="token function">match_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Send message to `DbExecutor` actor</span>
    req<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>db
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">CreateUser</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">from_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>res<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">match</span> res <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">InternalServerError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">responder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://github.com/actix/examples/tree/master/diesel/" target="_blank" rel="noopener noreferrer">示例目录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中提供了完整的示例。</p> <p>有关同步参与者的更多信息可以在<a href="https://docs.rs/actix/0.7.0/actix/sync/index.html" target="_blank" rel="noopener noreferrer">actix文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中找到。</p> <h2 id="图表"><a href="#图表" class="header-anchor">#</a> 图表</h2> <h3 id="http-服务初始化"><a href="#http-服务初始化" class="header-anchor">#</a> HTTP 服务初始化</h3> <h4 id="体系结构概述"><a href="#体系结构概述" class="header-anchor">#</a> 体系结构概述</h4> <p>下面是HttpServer初始化的示意图，它发生在以下代码上</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[actix_rt::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">to</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8088&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://actix.rs/img/diagrams/http_server.svg" alt=""></p> <h3 id="连接生命周期"><a href="#连接生命周期" class="header-anchor">#</a> 连接生命周期</h3> <h4 id="体系结构概述-2"><a href="#体系结构概述-2" class="header-anchor">#</a> 体系结构概述</h4> <p>在服务器开始监听所有套接字之后，<code>Accept</code>和<code>Worker</code>是两个主循环，负责处理传入的客户端连接。</p> <p>一旦连接被接受，应用程序级的协议处理就发生在从<code>Worker</code>派生的特定于协议的<code>Dispatcher</code>循环中。</p> <p>请注意，下面的图表仅勾勒了<code>happy-path</code>的场景</p> <p><img src="https://actix.rs/img/diagrams/connection_overview.svg" alt=""></p> <p>更详细地Accept循环</p> <p><img src="https://actix.rs/img/diagrams/connection_accept.svg" alt=""></p> <p>大多数代码实现位于<code>actix-server</code>机箱中，用于结构<code>Accept</code>。</p> <p>更详细的<code>Worker</code>循环</p> <p><img src="https://actix.rs/img/diagrams/connection_worker.svg" alt=""></p> <p>大多数代码实现都位于<code>actix-server</code> crate 的 <code>Worker</code>结构中。</p> <p>大致的请求循环</p> <p><img src="https://actix.rs/img/diagrams/connection_request.svg" alt=""></p> <p>请求循环的大多数代码实现位于<code>actix-web</code>和<code>actix-http</code>机箱中。</p> <h2 id="api-文档"><a href="#api-文档" class="header-anchor">#</a> API 文档</h2> <h3 id="actix"><a href="#actix" class="header-anchor">#</a> <a href="https://docs.rs/actix" target="_blank" rel="noopener noreferrer">actix<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h3 id="actix-web-2"><a href="#actix-web-2" class="header-anchor">#</a> <a href="https://docs.rs/actix-web/" target="_blank" rel="noopener noreferrer">actix-web<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3></div> </div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.da650921.js" defer></script><script src="/assets/js/2.cfea43a3.js" defer></script><script src="/assets/js/75.9b07dfb3.js" defer></script>
  </body>
</html>
